<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akıllı Beden Danışmanı - Premium Tee</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --brand-color: #1c1c1e; 
            --text-primary: #1c1c1e;
            --text-secondary: #555;
            --bg-primary: #ffffff;
            --bg-secondary: #f4f5f7;
            --bg-selected: #e9e9ed;
            --border-color: #e5e7eb;
            --button-bg: #1c1c1e;
            --button-text: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .product-card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
        }
        .product-card-image-bg {
            background-color: #f9f9f9;
        }

        #size-wizard-modal {
            background: rgba(30, 30, 32, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        #wizard-content {
            width: 100%;
            max-width: 480px;
            height: auto;
            max-height: 90dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
            border-radius: clamp(16px, 4vw, 24px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            color: var(--text-primary);
        }
        
        @media (min-width: 768px) {
            #wizard-content {
                min-height: 600px;
            }
        }

        .wizard-inner-scroll {
            flex: 1; 
            min-height: 0;
            overflow-y: auto;
            padding: 0 clamp(16px, 5vw, 24px) 24px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--brand-color) transparent;
        }
        .wizard-inner-scroll::-webkit-scrollbar { width: 5px; }
        .wizard-inner-scroll::-webkit-scrollbar-thumb { background-color: var(--brand-color); border-radius: 10px; }

        .visual-selector-card { 
            transition: transform 0.25s cubic-bezier(.4,0,.2,1), background-color 0.25s, box-shadow 0.25s;
            cursor: pointer;
            padding: 4px;
            border-radius: 12px;
            border: 2px solid transparent;
            background-color: transparent;
        }
        .visual-selector-card .image-wrapper {
            background-color: transparent;
            border-radius: 8px;
            overflow: hidden;
        }
        .visual-selector-card img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: contain;
            padding: 0;
            transition: transform 0.25s;
        }
        .visual-selector-card h4 {
            color: var(--text-secondary);
            font-weight: 600;
            transition: color 0.25s;
            font-size: clamp(0.6rem, 2.5vw, 0.875rem);
        }
        .visual-selector-card:hover img {
            transform: scale(1.05);
        }
        .visual-selector-card.selected { 
            background-color: var(--bg-selected);
            transform: translateY(-5px);
            outline: 1px solid #d1d5db; 
        }
        .visual-selector-card.selected h4 {
            color: var(--text-primary);
        }
        
        @media (max-width: 640px) {
            .visual-selector-card img {
                transform: scale(1.1);
            }
            .visual-selector-card:hover img {
                transform: scale(1.15);
            }
        }

        .measurement-card img {
            display: block;
            width: 100%;
            max-width: 300px;
            height: auto;
            aspect-ratio: 16 / 9;
            object-fit: contain;
            margin: 0 auto 1rem auto;
            border-radius: 8px;
            background-color: var(--bg-secondary);
        }

        h3.wizard-title {
            font-size: clamp(1.5rem, 4vw, 1.875rem);
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: clamp(0.4rem, 2vh, 1.5rem);
        }
        
        .wizard-label {
            color: var(--text-secondary);
            font-size: clamp(0.7rem, 2.5vw, 1rem);
            margin-bottom: 1rem;
        }

        .value-display {
            font-size: clamp(4rem, 12vw, 5rem);
            font-weight: 900;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .value-display-medium {
            font-size: clamp(3rem, 8vw, 4rem);
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }
        
        .modal-brand-footer {
            flex-shrink: 0;
            width: 100%;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: clamp(11px, 3vw, 15px);
            text-align: center;
            padding: 16px 0;
            letter-spacing: 1px;
            user-select: none;
            border-top: none;
        }
        .wizard-step { display: none; animation: fadeIn 0.4s; }
        .wizard-step.active { display: block; }
        #step-loader.active { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 300px;}
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border:4px solid var(--bg-secondary); border-top:4px solid var(--brand-color); border-radius:50%; width:46px; height:46px; animation:spin 1s linear infinite;}
        
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 5px; outline: none; transition: opacity .2s; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { width: 24px; height: 24px; background: var(--bg-primary); cursor: pointer; border-radius: 50%; border: 2px solid var(--brand-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: var(--bg-primary); cursor: pointer; border-radius: 50%; border: 2px solid var(--brand-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .slider-label {
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            color: var(--text-secondary);
            margin-top: 0.75rem;
            text-align: center;
        }

        .action-button {
            background-color: var(--button-bg);
            color: var(--button-text);
            transition: transform 0.2s, background-color 0.2s;
            font-size: clamp(0.7rem, 4vw, 1.125rem);
        }
        .action-button:hover {
            background-color: #333;
            transform: translateY(-2px);
        }
        .prev-btn {
            background-color: transparent;
            color: var(--text-secondary);
        }
        .prev-btn:hover {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        button:disabled{opacity:0.5;cursor:not-allowed;}
        
        .modal-alert { 
            color: #c21c25; 
            font-weight: 500; 
            font-size: clamp(0.8rem, 2.5vw, 0.875rem);
            text-align: center; 
            display: none;
            margin-top: 0.5rem;
        }
        
        .wizard-nav {
            flex-shrink: 0;
            padding: 1rem clamp(16px, 5vw, 24px);
            border-top: 1px solid var(--border-color);
        }

        @media (max-width:480px) {
            #wizard-content { max-width: 95vw; }
        }
    </style>
</head>
<body class="text-gray-900">

<div class="container mx-auto p-4 md:p-8">
    <h1 class="text-3xl font-bold mb-4 text-center tracking-tight text-gray-900">Premium Oversize Tee</h1>
    <div class="product-card max-w-md mx-auto rounded-xl shadow-lg overflow-hidden md:max-w-2xl border">
        <div class="md:flex">
            <div class="product-card-image-bg md:flex-shrink-0 flex items-center justify-center">
                <img class="h-48 w-full object-cover md:h-full md:w-48" src="https://placehold.co/600x800/f4f5f7/333?text=LOS%20SURENOS" alt="[LOS SURENOS Gri Tişört]" loading="lazy">
            </div>
            <div class="p-8">
                <div class="uppercase tracking-wide text-sm text-violet-600 font-semibold">Yeni Koleksiyon</div>
                <p class="block mt-1 text-lg leading-tight font-medium text-black">Unisex Boxy Fit Tee</p>
                <p class="mt-2 text-gray-600">Mükemmel kesimi ve premium kumaşıyla gardırobunuzun favorisi olacak.</p>
                <div class="mt-4">
                    <span class="text-2xl font-bold text-gray-900">749.99 TL</span>
                </div>
                <div class="mt-6">
                    <button id="open-wizard-btn" class="action-button w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                        <i data-lucide="scan-line" class="mr-2"></i>
                        Sana Özel Bedeni Bulalım
                    </button>
                    <p class="text-xs text-center mt-2 text-gray-500">Yapay zeka destekli beden danışmanını keşfet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="size-wizard-modal" class="fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
    <div id="wizard-content">
        <div class="flex-shrink-0 flex justify-center items-center p-4 border-b border-[var(--border-color)] relative">
            <h2 class="text-base font-bold flex items-center gap-2">
                <i data-lucide="badge-check" class="w-6 h-6 text-gray-800"></i> Akıllı Beden Danışmanı
            </h2>
            <button id="close-wizard-btn" class="text-gray-500 hover:text-gray-900 absolute top-1/2 right-4 -translate-y-1/2">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="flex-shrink-0 p-5 pt-4">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-gray-800 h-2.5 rounded-full transition-all duration-500" style="width:0%"></div>
            </div>
        </div>
        <div class="wizard-inner-scroll">
            <!-- YENİ Adım 0: Yaş ve Cinsiyet -->
            <div id="step-0" class="wizard-step active text-center">
                <h3 class="wizard-title">Seni Tanıyalım</h3>
                <p class="wizard-label">Doğru öneri için bu iki bilgi önemli.</p>
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold mb-2 text-lg">Yaş Grubu</h4>
                        <div class="grid grid-cols-2 gap-3" data-group="ageGroup">
                            <div class="visual-selector-card p-4 text-center" data-value="Genç (14-17)">
                                <h4>Genç (14-17)</h4>
                            </div>
                            <div class="visual-selector-card p-4 text-center" data-value="Yetişkin (18+)">
                                <h4>Yetişkin (18+)</h4>
                            </div>
                        </div>
                        <div id="age-alert" class="modal-alert">Lütfen bir yaş grubu seçiniz!</div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2 text-lg">Cinsiyet</h4>
                        <div class="grid grid-cols-2 gap-3" data-group="gender">
                            <div class="visual-selector-card p-4 text-center" data-value="Erkek">
                                <h4>Erkek</h4>
                            </div>
                            <div class="visual-selector-card p-4 text-center" data-value="Kadın">
                                <h4>Kadın</h4>
                            </div>
                        </div>
                         <div id="gender-alert" class="modal-alert">Lütfen bir cinsiyet seçiniz!</div>
                    </div>
                </div>
            </div>

            <!-- Adım 1: Yöntem Seçimi -->
            <div id="step-1" class="wizard-step text-center">
                <h3 class="wizard-title">Sana en uygun bedeni nasıl bulalım?</h3>
                <p class="wizard-label">İki farklı yöntemle sana özel önerimizi anında öğren.</p>
                <div class="space-y-4">
                    <button data-target-step="step-2" data-mode="wizard" class="start-btn action-button w-full font-bold py-4 px-4 rounded-lg flex items-center justify-center">
                        <i data-lucide="user-check" class="mr-3"></i> Vücut Ölçülerimle Bul
                    </button>
                    <button data-target-step="step-m1" data-mode="measure" class="start-btn action-button w-full font-bold py-4 px-4 rounded-lg flex items-center justify-center">
                        <i data-lucide="ruler" class="mr-3"></i> Favori Tişörtümü Ölçerek Bul
                    </button>
                </div>
                <p class="text-xs mt-6 text-gray-500"><i data-lucide="lock" class="inline-block w-3 h-3 mr-1"></i>Bilgilerin sadece beden hesaplamak için kullanılır.</p>
            </div>

            <!-- Adım 2: Boy Seçimi -->
            <div id="step-2" class="wizard-step">
                <div class="text-center">
                    <h3 class="wizard-title">Boyun kaç cm?</h3>
                    <p id="height-value-display" class="value-display">175 cm</p>
                    <input type="range" id="height-slider" min="140" max="200" value="175" class="w-full">
                    <p class="slider-label">Ölçüyü ayarlamak için kaydır</p>
                </div>
            </div>

            <!-- Adım 3: Kilo Seçimi -->
            <div id="step-3" class="wizard-step">
                <div class="text-center">
                    <h3 class="wizard-title">Kilon kaç kg?</h3>
                    <p id="weight-value-display" class="value-display">75 kg</p>
                    <input type="range" id="weight-slider" min="40" max="110" value="75" class="w-full">
                    <p class="slider-label">Ölçüyü ayarlamak için kaydır</p>
                </div>
            </div>

            <!-- Adım 4: Vücut Tipi -->
            <div id="step-4" class="wizard-step">
                <h3 class="wizard-title text-center">Vücut tipin hangisi?</h3>
                <div class="grid grid-cols-3 gap-2 mb-1" data-group="bodyType">
                    <div class="visual-selector-card text-center" data-value="İnce Yapılı">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/fe980448-a30c-47fd-8c65-05ec05b27034/image_1080.webp" alt="[İnce yapılı vücut tipi]"></div>
                        <h4 class="text-sm mt-2">İnce Yapılı</h4>
                    </div>
                    <div class="visual-selector-card text-center" data-value="Standart Yapılı">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/0db45a1b-030c-4c18-aee7-36e80cc89c40/image_1080.webp" alt="[Standart yapılı vücut tipi]"></div>
                        <h4 class="text-sm mt-2">Standart Yapılı</h4>
                    </div>
                    <div class="visual-selector-card text-center" data-value="İri Yapılı">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/c4b2e1b1-488c-408c-a388-3feedaa53955/image_1080.webp" alt="[İri yapılı vücut tipi]"></div>
                        <h4 class="text-sm mt-2">İri Yapılı</h4>
                    </div>
                </div>
                <div id="bodytype-alert" class="modal-alert">Lütfen bir vücut tipi seçiniz!</div>
            </div>

            <!-- Adım 5: Omuz Genişliği -->
            <div id="step-5" class="wizard-step">
                <h3 class="wizard-title text-center">Omuz genişliğin nasıl?</h3>
                <div class="grid grid-cols-3 gap-2 mb-1" data-group="shoulderWidth">
                    <div class="visual-selector-card text-center" data-value="Dar Omuz">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/0a00cb0e-637c-41d8-84ac-63d19065b16b/image_1080.webp" alt="[Dar omuzlu vücut tipi]"></div>
                        <h4 class="text-sm mt-2">Dar Omuz</h4>
                    </div>
                    <div class="visual-selector-card text-center" data-value="Normal Omuz">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/75e11e3b-a7ae-4205-9c9f-44ad00c208ac/image_1080.webp" alt="[Normal omuzlu vücut tipi]"></div>
                        <h4 class="text-sm mt-2">Normal Omuz</h4>
                    </div>
                    <div class="visual-selector-card text-center" data-value="Geniş Omuz">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/24c35eb8-abfb-4ab6-a33d-4f887ac3ab1a/image_1080.webp" alt="[Geniş omuzlu vücut tipi]"></div>
                        <h4 class="text-sm mt-2">Geniş Omuz</h4>
                    </div>
                </div>
                <div id="shoulder-alert" class="modal-alert">Lütfen bir omuz genişliği seçiniz!</div>
            </div>

            <!-- Adım M1 & M2 (Ölçüm) -->
            <div id="step-m1" class="wizard-step">
                <div class="text-center measurement-card">
                    <h3 class="wizard-title">Favori tişörtünün genişliği?</h3>
                    <img src="https://placehold.co/400x300/f4f5f7/333?text=Genişlik+(En)" alt="[Tişört genişlik ölçümü görseli]">
                    <p id="tee-width-display" class="value-display-medium mt-4">58 cm</p>
                    <input type="range" id="tee-width-slider" min="40" max="80" value="58" class="w-full">
                    <p class="slider-label">Ölçüyü ayarlamak için kaydır</p>
                </div>
            </div>
            <div id="step-m2" class="wizard-step">
                <div class="text-center measurement-card">
                    <h3 class="wizard-title">Favori tişörtünün boyu?</h3>
                    <img src="https://placehold.co/400x300/f4f5f7/333?text=Uzunluk+(Boy)" alt="[Tişört boy ölçümü görseli]">
                    <p id="tee-length-display" class="value-display-medium mt-4">72 cm</p>
                    <input type="range" id="tee-length-slider" min="60" max="90" value="72" class="w-full">
                    <p class="slider-label">Ölçüyü ayarlamak için kaydır</p>
                </div>
            </div>

            <!-- Yükleniyor Ekranı -->
            <div id="step-loader" class="wizard-step text-center">
                <div class="loader"></div>
                <h3 class="text-2xl font-bold mt-6">Analiz Ediliyor...</h3>
                <p class="text-gray-600 mt-2">✨ Yapay zeka, verilerinize göre en uygun bedeni ve kişisel yorumu hazırlıyor.</p>
            </div>

            <!-- Sonuç Ekranı - GELİŞMİŞ VERSİYON -->
            <div id="step-result" class="wizard-step text-center">
                <i data-lucide="party-popper" class="mx-auto w-16 h-16 text-green-500"></i>
                <h3 class="wizard-title mt-4">Sana Özel Önerimiz:</h3>
                <p id="result-size" class="text-7xl font-black text-gray-800 my-4">L</p>
                
                <!-- Güven Skoru -->
                <div class="mb-2">
                    <span id="confidence-score" class="text-sm font-semibold"></span>
                </div>
                
                <div class="bg-gray-100 rounded-lg p-4 text-sm text-left mb-3 border border-gray-200">
                    <p id="result-description"></p>
                    
                    <!-- Fit Analizi Konteyner -->
                    <div id="fit-analysis-container"></div>
                    
                    <!-- Alternatif Bedenler Konteyner -->
                    <div id="alternative-sizes-container"></div>
                    
                    <!-- Uyarılar Konteyner -->
                    <div id="warnings-container"></div>
                    
                    <div id="ai-fit-preview-section" class="mt-6 text-left">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">AI Destekli Fit Önizlemesi</h4>
                        <div id="fit-preview-container" class="w-full aspect-square bg-gray-200 rounded-lg flex items-center justify-center border border-gray-300 overflow-hidden relative">
                            <div id="fit-preview-loader" class="text-center flex flex-col items-center justify-center absolute inset-0">
                                <div class="loader"></div>
                                <p class="text-sm text-gray-600 mt-2">Önizleme oluşturuluyor...</p>
                            </div>
                            <img id="fit-preview-image" src="" alt="AI Destekli Fit Önizlemesi" class="w-full h-full object-cover hidden">
                        </div>
                        <p class="text-[11px] text-gray-500 mt-2 ml-1">Görsel, yapay zeka tarafından ölçülerinize özel olarak oluşturulmuştur.</p>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="add-to-cart-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Bu Bedeni Sepete Ekle</button>
                    <button class="restart-btn mt-2 w-full text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-200">Yeniden Başla</button>
                </div>
            </div>
        </div>
        <div class="wizard-nav">
            <div class="flex justify-between">
                <button id="nav-prev" class="prev-btn font-bold py-2 px-4 rounded-lg">Geri</button>
                <button id="nav-next" class="next-btn action-button font-bold py-2 px-6 rounded-lg">İleri</button>
                <button id="nav-analyze" class="analyze-btn action-button font-bold py-2 px-6 rounded-lg" style="display:none;">Analiz Et</button>
            </div>
        </div>
        <div class="modal-brand-footer">LOS SURENOS®</div>
    </div>
</div>

<div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100] hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
        <p id="custom-alert-message" class="text-lg text-gray-700 mb-4"></p>
        <button id="custom-alert-close-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Tamam</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Çeviri haritaları
    const enBodyTypes = {
        'İnce Yapılı': 'Slim build',
        'Standart Yapılı': 'Standard build',
        'İri Yapılı': 'Heavy-set build'
    };
    const enShoulderWidths = {
        'Dar Omuz': 'Narrow shoulders',
        'Normal Omuz': 'Standard shoulders',
        'Geniş Omuz': 'Broad shoulders'
    };

    // Element Selections
    const wizardModal = document.getElementById('size-wizard-modal');
    const steps = document.querySelectorAll('.wizard-step');
    const progressBar = document.getElementById('progress-bar');
    const navPrev = document.getElementById('nav-prev');
    const navNext = document.getElementById('nav-next');
    const navAnalyze = document.getElementById('nav-analyze');
    const heightSlider = document.getElementById('height-slider');
    const heightValueDisplay = document.getElementById('height-value-display');
    const weightSlider = document.getElementById('weight-slider');
    const weightValueDisplay = document.getElementById('weight-value-display');
    const teeWidthSlider = document.getElementById('tee-width-slider');
    const teeWidthDisplay = document.getElementById('tee-width-display');
    const teeLengthSlider = document.getElementById('tee-length-slider');
    const teeLengthDisplay = document.getElementById('tee-length-display');
    const bodyTypeAlert = document.getElementById('bodytype-alert');
    const shoulderAlert = document.getElementById('shoulder-alert');
    const ageAlert = document.getElementById('age-alert');
    const genderAlert = document.getElementById('gender-alert');
    const resultDescription = document.getElementById('result-description');
    const fitPreviewLoader = document.getElementById('fit-preview-loader');
    const fitPreviewImage = document.getElementById('fit-preview-image');

    // State Variables
    let currentStepId = 'step-0';
    let userData = {};
    const TEE_SIZE_CHART = {
        'S': { width: 60, length: 70 },
        'M': { width: 62, length: 72 },
        'L': { width: 64, length: 74 },
        'XL': { width: 66, length: 76 }
    };

    // Modal & Alert Logic
    const openModal = () => { wizardModal.classList.remove('hidden'); resetWizard(); };
    const closeModal = () => { wizardModal.classList.add('hidden');};
    const showAlert = (message) => { document.getElementById('custom-alert-message').textContent = message; document.getElementById('custom-alert-modal').classList.remove('hidden'); };
    document.getElementById('open-wizard-btn').addEventListener('click', openModal);
    document.getElementById('close-wizard-btn').addEventListener('click', closeModal);
    wizardModal.addEventListener('click', (e) => e.target === wizardModal && closeModal());
    document.getElementById('custom-alert-close-btn').addEventListener('click', () => { document.getElementById('custom-alert-modal').classList.add('hidden'); });

    // Navigation config
    const stepConfig = {
        'step-0': { prev: null, next: 'step-1' },
        'step-1': { prev: 'step-0', next: null, hideNav: true },
        'step-2': { prev: 'step-1', next: 'step-3' },
        'step-3': { prev: 'step-2', next: (data) => data.mode === 'wizard' ? 'step-4' : null, isAnalyze: (data) => data.mode === 'measure' },
        'step-4': { prev: 'step-3', next: 'step-5' },
        'step-5': { prev: 'step-4', next: null, isAnalyze: true },
        'step-m1': { prev: 'step-1', next: 'step-m2' },
        'step-m2': { prev: 'step-m1', next: 'step-2' },
        'step-loader': { hideNav: true },
        'step-result': { hideNav: true }
    };

    const updateNavigation = (stepId) => {
        const config = stepConfig[stepId];
        const navContainer = document.querySelector('.wizard-nav');
        if (!config) return;
        if (config.hideNav) { navContainer.style.display = 'none'; return; }
        navContainer.style.display = 'block';
        navPrev.style.display = config.prev ? 'block' : 'none';
        if(config.prev) navPrev.dataset.targetStep = config.prev;
        const nextTarget = typeof config.next === 'function' ? config.next(userData) : config.next;
        navNext.style.display = nextTarget ? 'block' : 'none';
        if(nextTarget) navNext.dataset.targetStep = nextTarget;
        const showAnalyze = typeof config.isAnalyze === 'function' ? config.isAnalyze(userData) : config.isAnalyze;
        navAnalyze.style.display = showAnalyze ? 'block' : 'none';
        if(showAnalyze) navNext.style.display = 'none';
    };
    
    const showStep = (stepId) => {
        // Yaş ve cinsiyet kontrolü
        if (currentStepId === 'step-0' && stepId === 'step-1') {
            if (!userData.ageGroup) {
                ageAlert.style.display = "block"; setTimeout(() => ageAlert.style.display = "none", 1800); return;
            }
            if (!userData.gender) {
                genderAlert.style.display = "block"; setTimeout(() => genderAlert.style.display = "none", 1800); return;
            }
        }
        if (currentStepId === 'step-4' && stepId === 'step-5' && !userData.bodyType) {
            bodyTypeAlert.style.display = "block"; setTimeout(() => bodyTypeAlert.style.display = "none", 1800); return;
        }
        if (currentStepId === 'step-5' && stepId.startsWith('step-loader') && !userData.shoulderWidth) {
            shoulderAlert.style.display = "block"; setTimeout(() => shoulderAlert.style.display = "none", 1800); return;
        }
        currentStepId = stepId;
        steps.forEach(step => step.classList.remove('active'));
        const activeStep = document.getElementById(stepId);
        if (activeStep) activeStep.classList.add('active');
        document.querySelector('.wizard-inner-scroll').scrollTop = 0;
        updateProgressBar();
        updateNavigation(stepId);
    };

    const updateProgressBar = () => {
        const wizardFlow = ['step-0', 'step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
        const measureFlow = ['step-0', 'step-1', 'step-m1', 'step-m2', 'step-2', 'step-3'];
        const currentFlow = userData.mode === 'wizard' ? wizardFlow : measureFlow;
        const stepIndex = currentFlow.indexOf(currentStepId);
        let progress = 0;
        if (stepIndex !== -1) {
            progress = ((stepIndex + 1) / currentFlow.length) * 100;
        } else if (currentStepId === 'step-result' || currentStepId.startsWith('step-loader')) {
            progress = 100;
        }
        progressBar.style.width = `${progress}%`;
    };
    
    document.querySelectorAll('.start-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            userData.mode = btn.dataset.mode;
            showStep(btn.dataset.targetStep);
        });
    });

    navPrev.addEventListener('click', () => showStep(navPrev.dataset.targetStep));
    navNext.addEventListener('click', () => showStep(navNext.dataset.targetStep));
    navAnalyze.addEventListener('click', () => runAnalysis());
    
    // Restart button için güvenli event listener
    const restartBtn = document.querySelector('.restart-btn');
    if (restartBtn) {
        restartBtn.addEventListener('click', () => resetWizard());
    }

    // Sliders
    heightSlider.addEventListener('input', (e) => heightValueDisplay.textContent = `${e.target.value} cm`);
    weightSlider.addEventListener('input', (e) => weightValueDisplay.textContent = `${e.target.value} kg`);
    teeWidthSlider.addEventListener('input', (e) => teeWidthDisplay.textContent = `${e.target.value} cm`);
    teeLengthSlider.addEventListener('input', (e) => teeLengthDisplay.textContent = `${e.target.value} cm`);
    
    document.querySelectorAll('.visual-selector-card').forEach(card => {
        card.addEventListener('click', () => {
            const group = card.closest('[data-group]').dataset.group;
            document.querySelectorAll(`[data-group="${group}"] .visual-selector-card`).forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            userData[group] = card.dataset.value;
        });
    });

    // GELİŞMİŞ BEDEN TAHMİNİ ALGORİTMASI - YAŞA VE CİNSİYETE GÖRE GÜNCELLENDİ
    function getImprovedSizeRecommendation(height, weight, ageGroup, gender, bodyType, shoulderWidth, teeWidth = null, teeLength = null) {
        const bmi = weight / ((height / 100) * (height / 100));
        
        // Yaş ve cinsiyet bazlı fizik profili oluştur
        const physiqueProfile = createEnhancedPhysiqueProfile(height, weight, bmi, ageGroup, gender, bodyType, shoulderWidth);
        
        // Ürün gereksinimlerini hesapla
        const productRequirements = calculateEnhancedProductRequirements(physiqueProfile);
        
        // Eğer ölçü verisi varsa doğrula
        if (teeWidth && teeLength) {
            return validateWithMeasurements(productRequirements, teeWidth, teeLength);
        }
        
        return productRequirements;
    }

    function createEnhancedPhysiqueProfile(height, weight, bmi, ageGroup, gender, bodyType, shoulderWidth) {
        return {
            height,
            weight,
            bmi,
            ageGroup,
            gender,
            bodyType,
            shoulderWidth,
            heightCategory: getGenderAwareHeightCategory(height, gender),
            weightCategory: getWeightCategory(bmi),
            bodyFrame: getBodyFrame(bodyType, shoulderWidth),
            chestEstimate: estimateGenderAwareChestWidth(height, weight, gender, bodyType, shoulderWidth),
            shoulderEstimate: estimateShoulderWidth(height, bodyType, shoulderWidth),
            torsoLength: estimateTorsoLength(height),
            fitPreference: getGenderAgeFitPreference(ageGroup, gender, bodyType, shoulderWidth)
        };
    }

    function getGenderAwareHeightCategory(height, gender) {
        const femaleThresholds = { very_short: 155, short: 160, average: 170, tall: 175, very_tall: 180 };
        const maleThresholds = { very_short: 165, short: 170, average: 175, tall: 180, very_tall: 185 };
        const thresholds = gender === 'Kadın' ? femaleThresholds : maleThresholds;
        
        if (height < thresholds.very_short) return 'very_short';
        if (height < thresholds.short) return 'short';
        if (height < thresholds.average) return 'average';
        if (height < thresholds.tall) return 'tall';
        if (height < thresholds.very_tall) return 'very_tall';
        return 'extremely_tall';
    }

    function estimateGenderAwareChestWidth(height, weight, gender, bodyType, shoulderWidth) {
        let baseChest = gender === 'Kadın' ? 0.26 * height : 0.28 * height;
        
        const bmi = weight / ((height / 100) * (height / 100));
        const bmiAdjustment = (bmi - 22) * (gender === 'Kadın' ? 1.0 : 1.2);
        
        const bodyTypeAdjustment = {
            'İnce Yapılı': gender === 'Kadın' ? -2 : -3,
            'Standart Yapılı': 0,
            'İri Yapılı': gender === 'Kadın' ? 3 : 4
        };
        
        const shoulderAdjustment = {
            'Dar Omuz': -2,
            'Normal Omuz': 0,
            'Geniş Omuz': gender === 'Kadın' ? 2 : 3
        };
        
        return Math.round(baseChest + bmiAdjustment + 
                         bodyTypeAdjustment[bodyType] + 
                         shoulderAdjustment[shoulderWidth]);
    }

    function getGenderAgeFitPreference(ageGroup, gender, bodyType, shoulderWidth) {
        // Genç kızlar ve kadınlar genelde daha rahat fit tercih eder
        if (gender === 'Kadın') {
            if (bodyType === 'İnce Yapılı') {
                return ageGroup === 'Genç (14-17)' ? 'very_loose_fit' : 'loose_fit';
            } else if (bodyType === 'İri Yapılı') {
                return 'very_loose_fit';
            }
            return 'loose_fit';
        } else {
            // Erkekler için mevcut mantık
            if (bodyType === 'İnce Yapılı') {
                return shoulderWidth === 'Dar Omuz' ? 'loose_fit' : 'relaxed_fit';
            } else if (bodyType === 'İri Yapılı') {
                return shoulderWidth === 'Geniş Omuz' ? 'very_loose_fit' : 'loose_fit';
            }
            return ageGroup === 'Genç (14-17)' ? 'relaxed_fit' : 'standard_fit';
        }
    }

    // Temel helper fonksiyonlar (önceki koddan)
    function getHeightCategory(height) {
        if (height < 165) return 'very_short';
        if (height < 170) return 'short';
        if (height < 175) return 'average';
        if (height < 180) return 'tall';
        if (height < 185) return 'very_tall';
        return 'extremely_tall';
    }

    function getWeightCategory(bmi) {
        if (bmi < 16) return 'severely_underweight';
        if (bmi < 18.5) return 'underweight';
        if (bmi < 25) return 'normal';
        if (bmi < 30) return 'overweight';
        if (bmi < 35) return 'obese_1';
        if (bmi < 40) return 'obese_2';
        return 'obese_3';
    }

    function getBodyFrame(bodyType, shoulderWidth) {
        const frameMap = {
            'İnce Yapılı': {
                'Dar Omuz': 'small_narrow',
                'Normal Omuz': 'small_normal',
                'Geniş Omuz': 'small_broad'
            },
            'Standart Yapılı': {
                'Dar Omuz': 'medium_narrow',
                'Normal Omuz': 'medium_normal',
                'Geniş Omuz': 'medium_broad'
            },
            'İri Yapılı': {
                'Dar Omuz': 'large_narrow',
                'Normal Omuz': 'large_normal',
                'Geniş Omuz': 'large_broad'
            }
        };
        
        return frameMap[bodyType][shoulderWidth] || 'medium_normal';
    }

    function estimateShoulderWidth(height, bodyType, shoulderWidth) {
        let baseShoulder = 0.25 * height;
        
        const bodyTypeAdjustment = {
            'İnce Yapılı': -2,
            'Standart Yapılı': 0,
            'İri Yapılı': 3
        };
        
        const shoulderAdjustment = {
            'Dar Omuz': -4,
            'Normal Omuz': 0,
            'Geniş Omuz': 6
        };
        
        return Math.round(baseShoulder + 
                         bodyTypeAdjustment[bodyType] + 
                         shoulderAdjustment[shoulderWidth]);
    }

    function estimateTorsoLength(height) {
        return Math.round(height * 0.535);
    }

    function calculateEnhancedProductRequirements(profile) {
        const requiredWidth = profile.chestEstimate + getComfortMargin(profile.fitPreference);
        const requiredLength = Math.max(profile.torsoLength * (profile.gender === 'Kadın' ? 0.58 : 0.6), 65);
        
        let bestSize = 'S';
        let bestScore = -1;
        
        for (const [size, measurements] of Object.entries(TEE_SIZE_CHART)) {
            const score = calculateFitScore(measurements, requiredWidth, requiredLength, profile);
            
            if (score > bestScore) {
                bestScore = score;
                bestSize = size;
            }
        }
        
        return {
            recommendedSize: bestSize,
            confidence: Math.min(Math.max(bestScore * 100, 60), 100),
            measurements: TEE_SIZE_CHART[bestSize],
            profile,
            reasoning: generateEnhancedReasoning(profile, bestSize, TEE_SIZE_CHART[bestSize])
        };
    }

    function getComfortMargin(fitPreference) {
        const margins = {
            'tight_fit': 8,
            'standard_fit': 12,
            'relaxed_fit': 16,
            'loose_fit': 20,
            'very_loose_fit': 24
        };
        
        return margins[fitPreference] || 12;
    }

    function calculateFitScore(measurements, requiredWidth, requiredLength, profile) {
        let score = 0;
        
        if (measurements.width >= requiredWidth) {
            const excess = measurements.width - requiredWidth;
            if (excess >= 2 && excess <= 6) {
                score += 0.5;
            } else if (excess < 2) {
                score += 0.3;
            } else {
                score += Math.max(0, 0.5 - (excess - 6) * 0.05);
            }
        } else {
            score -= 0.3;
        }
        
        if (measurements.length >= requiredLength) {
            const excess = measurements.length - requiredLength;
            if (excess >= 5 && excess <= 10) {
                score += 0.5;
            } else if (excess < 5) {
                score += 0.3;
            } else {
                score += Math.max(0, 0.5 - (excess - 10) * 0.03);
            }
        } else {
            score -= 0.2;
        }
        
        return score;
    }

    function generateEnhancedReasoning(profile, size, measurements) {
        const reasons = [];
        
        // Yaş ve cinsiyet bazlı açıklamalar
        if (profile.gender === 'Kadın') {
            reasons.push(`Kadın kesimi için oversized fit tercihleriniz dikkate alındı`);
        }
        
        if (profile.ageGroup === 'Genç (14-17)') {
            reasons.push(`Genç yaş grubunuz için modern ve rahat bir kesim seçildi`);
        }
        
        // Boy analizi
        if (profile.heightCategory === 'very_short' || profile.heightCategory === 'short') {
            reasons.push(`${profile.gender === 'Kadın' ? 'Kısa boyunuz' : 'Kısa boyunuz'} (${profile.height}cm) göz önünde bulunduruldu`);
        } else if (profile.heightCategory === 'very_tall' || profile.heightCategory === 'extremely_tall') {
            reasons.push(`Uzun boyunuz (${profile.height}cm) için uygun boy seçildi`);
        }
        
        // Kilo analizi
        if (profile.weightCategory === 'underweight' || profile.weightCategory === 'severely_underweight') {
            reasons.push(`Zayıf yapınız için rahat bir kesim önerildi`);
        } else if (profile.weightCategory.includes('obese') || profile.weightCategory === 'overweight') {
            reasons.push(`Dolgun yapınız için yeterli genişlik sağlandı`);
        }
        
        // Vücut tipi analizi
        if (profile.bodyFrame.includes('broad')) {
            reasons.push(`Geniş omuz yapınız için uygun genişlik seçildi`);
        } else if (profile.bodyFrame.includes('narrow')) {
            reasons.push(`Dar omuz yapınız için uygun proporsiyon sağlandı`);
        }
        
        return reasons.length > 0 ? reasons.join(', ') : `Beden ${size}, tüm özelliklerinize uygun olarak seçildi`;
    }

    function validateWithMeasurements(recommendation, actualTeeWidth, actualTeeLength) {
        const { measurements } = recommendation;
        
        const widthDifference = measurements.width - actualTeeWidth;
        const lengthDifference = measurements.length - actualTeeLength;
        
        let adjustment = '';
        
        if (Math.abs(widthDifference) > 3 || Math.abs(lengthDifference) > 3) {
            if (widthDifference > 3) {
                adjustment = 'Mevcut tişörtünüz dar geliyorsa, önerdiğimiz beden tam size göre';
            } else if (widthDifference < -3) {
                adjustment = 'Mevcut tişörtünüz bol geliyorsa, önerdiğimiz beden daha iyi oturacak';
            }
        }
        
        return {
            ...recommendation,
            measurementComparison: { widthDifference, lengthDifference, adjustment }
        };
    }

    // GELİŞMİŞ GEMİNİ AI ANALİZİ - YAŞA VE CİNSİYETE GÖRE GÜNCELLENDİ
    const getAdvancedGeminiRecommendation = async (userData) => {
        try {
            const analysisReport = createComprehensiveAnalysisReport(userData);
            const prompt = buildAdvancedGeminiPrompt(analysisReport, userData.mode);
            
            const payload = {
                contents: [{ 
                    role: "user", 
                    parts: [{ text: prompt }] 
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "recommendedSize": { 
                                "type": "STRING", 
                                "enum": ["S", "M", "L", "XL"] 
                            },
                            "confidence": { 
                                "type": "NUMBER", 
                                "minimum": 0, 
                                "maximum": 100 
                            },
                            "explanation": { 
                                "type": "STRING",
                                "minLength": 50,
                                "maxLength": 300
                            },
                            "fitAnalysis": {
                                "type": "OBJECT",
                                "properties": {
                                    "chestFit": { "type": "STRING" },
                                    "lengthFit": { "type": "STRING" },
                                    "shoulderFit": { "type": "STRING" },
                                    "overallFit": { "type": "STRING" }
                                }
                            },
                            "alternativeSizes": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "size": { "type": "STRING" },
                                        "reason": { "type": "STRING" }
                                    }
                                }
                            },
                            "warnings": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "STRING"
                                }
                            }
                        },
                        "required": ["recommendedSize", "confidence", "explanation"]
                    }
                }
            };
            
            return await callBackendAPI("/api/gemini", payload);
        } catch (error) {
            console.error('Gemini API hatası:', error);
            return null;
        }
    };

    function createComprehensiveAnalysisReport(userData) {
        const { height, weight, ageGroup, gender, bodyType, shoulderWidth, teeWidth, teeLength, mode } = userData;
        const bmi = weight / ((height / 100) * (height / 100));
        
        const physicalProfile = {
            height: parseInt(height),
            weight: parseInt(weight),
            bmi: Math.round(bmi * 10) / 10,
            bmiCategory: getBMICategory(bmi),
            ageGroup,
            gender,
            bodyType,
            shoulderWidth,
            estimatedChest: estimateGenderAwareChestWidth(parseInt(height), parseInt(weight), gender, bodyType, shoulderWidth),
            estimatedShoulder: estimateShoulderWidth(parseInt(height), bodyType, shoulderWidth),
            bodyFrameType: getAdvancedBodyFrameType(bodyType, shoulderWidth, bmi, gender, ageGroup)
        };
        
        const productRequirements = {
            minimumChestWidth: physicalProfile.estimatedChest + getMinimumComfort(bodyType),
            idealChestWidth: physicalProfile.estimatedChest + getIdealComfort(bodyType),
            minimumLength: getMinimumLength(parseInt(height), gender),
            idealLength: getIdealLength(parseInt(height), bodyType, gender)
        };
        
        let currentGarmentAnalysis = null;
        if (mode === 'measure' && teeWidth && teeLength) {
            currentGarmentAnalysis = {
                currentWidth: parseInt(teeWidth),
                currentLength: parseInt(teeLength),
                widthFeedback: analyzeCurrentFit(parseInt(teeWidth), physicalProfile.estimatedChest),
                lengthFeedback: analyzeCurrentLength(parseInt(teeLength), parseInt(height), bodyType)
            };
        }
        
        return {
            physicalProfile,
            productRequirements,
            currentGarmentAnalysis,
            riskFactors: identifyRiskFactors(physicalProfile, bodyType, shoulderWidth),
            specialConsiderations: getSpecialConsiderations(physicalProfile)
        };
    }

    function getBMICategory(bmi) {
        if (bmi < 16) return 'Ciddi Zayıflık';
        if (bmi < 18.5) return 'Zayıf';
        if (bmi < 25) return 'Normal';
        if (bmi < 30) return 'Kilolu';
        if (bmi < 35) return 'Obez (1. Derece)';
        if (bmi < 40) return 'Obez (2. Derece)';
        return 'Obez (3. Derece)';
    }

    function getAdvancedBodyFrameType(bodyType, shoulderWidth, bmi, gender, ageGroup) {
        const baseFrameTypes = {
            'İnce Yapılı': {
                'Dar Omuz': bmi < 19 ? 'Çok İnce Dar Omuz' : 'İnce Dar Omuz',
                'Normal Omuz': bmi < 19 ? 'Çok İnce Normal' : 'İnce Normal',
                'Geniş Omuz': bmi < 19 ? 'İnce Geniş Omuz' : 'Athletic İnce'
            },
            'Standart Yapılı': {
                'Dar Omuz': bmi < 25 ? 'Standart Dar' : 'Dolgun Dar',
                'Normal Omuz': bmi < 25 ? 'İdeal Standart' : 'Dolgun Standart',
                'Geniş Omuz': bmi < 25 ? 'Athletic Standart' : 'Güçlü Yapılı'
            },
            'İri Yapılı': {
                'Dar Omuz': bmi < 30 ? 'İri Dar Omuz' : 'Ağır İri Dar',
                'Normal Omuz': bmi < 30 ? 'Klasik İri' : 'Ağır İri',
                'Geniş Omuz': bmi < 30 ? 'Güçlü İri' : 'Çok Ağır İri'
            }
        };
        
        let frameType = baseFrameTypes[bodyType][shoulderWidth];
        
        // Cinsiyet ve yaş modifikasyonu
        if (gender === 'Kadın') {
            frameType += ' (Kadın)';
        }
        if (ageGroup === 'Genç (14-17)') {
            frameType += ' (Genç)';
        }
        
        return frameType;
    }

    function identifyRiskFactors(profile, bodyType, shoulderWidth) {
        const risks = [];
        
        if (profile.height < 160) {
            risks.push('Çok kısa boy - standart bedenler uzun gelebilir');
        } else if (profile.height > 190) {
            risks.push('Çok uzun boy - standart bedenler kısa kalabilir');
        }
        
        if (profile.bmi < 17) {
            risks.push('Çok zayıf - tüm bedenler bol gelebilir');
        } else if (profile.bmi > 35) {
            risks.push('Ağır kilo - bedenler dar gelebilir');
        }
        
        if (bodyType === 'İnce Yapılı' && profile.bmi > 27) {
            risks.push('Vücut tipi algısı ile BMI arasında çelişki');
        } else if (bodyType === 'İri Yapılı' && profile.bmi < 20) {
            risks.push('Vücut tipi algısı ile BMI arasında çelişki');
        }
        
        // Yaş ve cinsiyet bazlı riskler
        if (profile.gender === 'Kadın' && profile.ageGroup === 'Genç (14-17)') {
            risks.push('Genç kadın - büyüme devam edebilir');
        }
        
        return risks;
    }

    function getSpecialConsiderations(profile) {
        const considerations = [];
        
        if (profile.height < 165) {
            considerations.push('Kısa boy için boy oranları kontrol edilmeli');
        } else if (profile.height > 185) {
            considerations.push('Uzun boy için yeterli boy uzunluğu kritik');
        }
        
        if (profile.bmi < 18.5) {
            considerations.push('Zayıf yapı için rahat kesim tercih edilmeli');
        } else if (profile.bmi > 30) {
            considerations.push('Ağır yapı için yeterli genişlik sağlanmalı');
        }
        
        // Cinsiyet ve yaş bazlı özel durumlar
        if (profile.gender === 'Kadın') {
            considerations.push('Kadın kesimi için oversized fit tercihleri dikkate alındı');
        }
        
        if (profile.ageGroup === 'Genç (14-17)') {
            considerations.push('Genç yaş grubu için büyüme potansiyeli göz önünde bulunduruldu');
        }
        
        return considerations;
    }

    function getMinimumComfort(bodyType) {
        const comfortMargins = {
            'İnce Yapılı': 10,
            'Standart Yapılı': 12,
            'İri Yapılı': 15
        };
        return comfortMargins[bodyType] || 12;
    }

    function getIdealComfort(bodyType) {
        const idealMargins = {
            'İnce Yapılı': 16,
            'Standart Yapılı': 18,
            'İri Yapılı': 22
        };
        return idealMargins[bodyType] || 18;
    }

    function getMinimumLength(height, gender = 'Erkek') {
        const baseFactor = gender === 'Kadın' ? 0.34 : 0.35;
        return Math.max(height * baseFactor, 65);
    }

    function getIdealLength(height, bodyType, gender = 'Erkek') {
        const baseFactor = gender === 'Kadın' ? 0.37 : 0.38;
        const baseLength = height * baseFactor;
        const typeAdjustment = {
            'İnce Yapılı': 2,
            'Standart Yapılı': 0,
            'İri Yapılı': -1
        };
        return Math.round(baseLength + typeAdjustment[bodyType]);
    }

    function analyzeCurrentFit(currentWidth, estimatedChest) {
        const difference = currentWidth - estimatedChest;
        
        if (difference < 8) return 'Mevcut tişört dar geliyor olabilir';
        if (difference > 20) return 'Mevcut tişört çok bol geliyor olabilir';
        if (difference >= 12 && difference <= 16) return 'Mevcut tişört ideal fit';
        return 'Mevcut tişört kabul edilebilir fit';
    }

    function analyzeCurrentLength(currentLength, height, bodyType) {
        const idealLength = getIdealLength(height, bodyType);
        const difference = currentLength - idealLength;
        
        if (difference < -5) return 'Mevcut tişört kısa kalıyor olabilir';
        if (difference > 8) return 'Mevcut tişört uzun geliyor olabilir';
        if (Math.abs(difference) <= 3) return 'Mevcut tişört boy olarak ideal';
        return 'Mevcut tişört boy olarak kabul edilebilir';
    }

    function buildAdvancedGeminiPrompt(analysisReport, mode) {
        const basePersona = `
🎯 UZMAN PROFIL: Sen LOS SURENOS markasının senior stil danışmanısın. 15 yıllık deneyimin var.

📋 ÜRÜN SPESİFİKASYONLARI:
- Ürün: Oversized Boxy Fit Tee (220 GSM ağır pamuk)
- Kalıp: Modern, geniş, boxy kesim
- Bedenler: S(60x70cm), M(62x72cm), L(64x74cm), XL(66x76cm)
- Hedef: Rahat, modern oversize görünüm

🔍 ANALİZ RAPORU:
`;

        const physicalAnalysis = `
**MÜŞTERİ PROFİLİ:**
- Yaş Grubu: ${analysisReport.physicalProfile.ageGroup}
- Cinsiyet: ${analysisReport.physicalProfile.gender}
- Boy: ${analysisReport.physicalProfile.height}cm
- Kilo: ${analysisReport.physicalProfile.weight}kg  
- BMI: ${analysisReport.physicalProfile.bmi} (${analysisReport.physicalProfile.bmiCategory})
- Vücut Tipi: ${analysisReport.physicalProfile.bodyType}
- Omuz Genişliği: ${analysisReport.physicalProfile.shoulderWidth}
- Tahmini Göğüs: ${analysisReport.physicalProfile.estimatedChest}cm
- Vücut Çerçevesi: ${analysisReport.physicalProfile.bodyFrameType}
`;

        const requirements = `
**ÜRÜN GEREKSİNİMLERİ:**
- Minimum Genişlik: ${analysisReport.productRequirements.minimumChestWidth}cm
- İdeal Genişlik: ${analysisReport.productRequirements.idealChestWidth}cm
- Minimum Boy: ${analysisReport.productRequirements.minimumLength}cm
- İdeal Boy: ${analysisReport.productRequirements.idealLength}cm
`;

        let currentGarmentSection = '';
        if (analysisReport.currentGarmentAnalysis) {
            currentGarmentSection = `
**MEVCUT KIYAFET ANALİZİ:**
- Mevcut Genişlik: ${analysisReport.currentGarmentAnalysis.currentWidth}cm
- Mevcut Boy: ${analysisReport.currentGarmentAnalysis.currentLength}cm
- Genişlik Değerlendirmesi: ${analysisReport.currentGarmentAnalysis.widthFeedback}
- Boy Değerlendirmesi: ${analysisReport.currentGarmentAnalysis.lengthFeedback}
`;
        }

        const riskSection = analysisReport.riskFactors.length > 0 ? `
**RİSK FAKTÖRLERİ:**
${analysisReport.riskFactors.map(risk => `- ${risk}`).join('\n')}
` : '';

        const considerationsSection = analysisReport.specialConsiderations.length > 0 ? `
**ÖZEL DURUMLAR:**
${analysisReport.specialConsiderations.map(consideration => `- ${consideration}`).join('\n')}
` : '';

        const expertTask = `
🎯 UZMAN GÖREVİN:

1. **KAPSAMLI DEĞERLENDİRME**: Tüm veriyi analiz et, yaş-cinsiyet kombinasyonunu özellikle dikkate al
2. **NİHAİ KARAR**: En uygun bedeni belirle (S/M/L/XL)
3. **GÜVEN SKORU**: Kararının güvenilirlik yüzdesini ver (0-100)
4. **DETAYLI AÇIKLAMA**: Yaş, cinsiyet, vücut özelliklerini harmanlayan açıklama yap
5. **FIT ANALİZİ**: Göğüs, boy, omuz ve genel uyumu değerlendir
6. **ALTERNATİFLER**: Varsa diğer seçenekleri ve nedenlerini belirt
7. **UYARILAR**: Yaş ve cinsiyete özel dikkat edilmesi gereken durumlar

⚠️ MUTLAK KURALLAR:
- SADECE S, M, L, XL kullan
- Reklam yapma, marka övme
- JSON formatında yanıtla
- Kişisel ve samimi dil kullan
- Yaş ve cinsiyet özelliklerini kararında dikkate al

${mode === 'measure' ? '📏 NOT: Müşteri mevcut ölçülerini verdi, bunu dikkate al.' : '🧙‍♂️ NOT: Müşteri wizard modunda, tahminlere dayalı karar ver.'}
`;

        return `${basePersona}${physicalAnalysis}${requirements}${currentGarmentSection}${riskSection}${considerationsSection}${expertTask}`;
    }

    // GELİŞMİŞ GÖRSEL OLUŞTURMA SİSTEMİ - YAŞA VE CİNSİYETE GÖRE GÜNCELLENDİ
    const generateAdvancedFitPreview = async (userData) => {
        try {
            const { height, weight, ageGroup, gender, bodyType, shoulderWidth, recommendedSize } = userData;
            
            const physiqueProfile = createDetailedPhysiqueProfile(height, weight, ageGroup, gender, bodyType, shoulderWidth);
            const imagePrompt = buildAdvancedImagePrompt(physiqueProfile, recommendedSize);
            
            const payload = {
                prompt: imagePrompt,
                seed: 500097 // Sabit seed kullanıyoruz
            };
            
            return await callBackendAPI("/api/generate-image", payload);
        } catch (error) {
            console.error('Görsel oluşturma hatası:', error);
            return null;
        }
    };

    function createDetailedPhysiqueProfile(height, weight, ageGroup, gender, bodyType, shoulderWidth) {
        const bmi = weight / ((height / 100) * (height / 100));
        
        return {
            height: parseInt(height),
            weight: parseInt(weight),
            bmi,
            ageGroup,
            gender,
            bodyType,
            shoulderWidth,
            heightCategory: getDetailedHeightCategory(height, gender),
            weightCategory: getDetailedWeightCategory(bmi),
            bodyFrame: getDetailedBodyFrame(bodyType, shoulderWidth, bmi),
            visualDescriptors: getEnhancedVisualDescriptors(height, weight, bmi, ageGroup, gender, bodyType, shoulderWidth)
        };
    }

    function getDetailedHeightCategory(height, gender) {
        const femaleThresholds = [155, 160, 170, 175, 180];
        const maleThresholds = [165, 170, 175, 180, 185];
        const thresholds = gender === 'Kadın' ? femaleThresholds : maleThresholds;
        
        if (height < thresholds[0]) return { category: 'very_short', intensity: 'extreme' };
        if (height < thresholds[1]) return { category: 'very_short', intensity: 'moderate' };
        if (height < thresholds[2]) return { category: 'short', intensity: 'noticeable' };
        if (height < thresholds[3]) return { category: 'average', intensity: 'standard' };
        if (height < thresholds[4]) return { category: 'tall', intensity: 'noticeable' };
        return { category: 'very_tall', intensity: 'significant' };
    }

    function getDetailedWeightCategory(bmi) {
        if (bmi < 16) return { category: 'severely_underweight', intensity: 'extreme', description: 'very gaunt and skeletal' };
        if (bmi < 18.5) return { category: 'underweight', intensity: 'significant', description: 'noticeably thin and lean' };
        if (bmi < 20) return { category: 'lean', intensity: 'moderate', description: 'slim and athletic' };
        if (bmi < 25) return { category: 'normal', intensity: 'standard', description: 'balanced and proportioned' };
        if (bmi < 27) return { category: 'slightly_overweight', intensity: 'mild', description: 'slightly fuller' };
        if (bmi < 30) return { category: 'overweight', intensity: 'moderate', description: 'noticeably heavier with visible softness' };
        if (bmi < 35) return { category: 'obese_class1', intensity: 'significant', description: 'substantially overweight with prominent belly' };
        if (bmi < 40) return { category: 'obese_class2', intensity: 'severe', description: 'very heavy with large torso and limbs' };
        return { category: 'obese_class3', intensity: 'extreme', description: 'extremely heavy with very large proportions' };
    }

    function getDetailedBodyFrame(bodyType, shoulderWidth, bmi) {
        const frameMatrix = {
            'İnce Yapılı': {
                'Dar Omuz': bmi < 20 ? 'ectomorph_narrow' : 'lean_narrow',
                'Normal Omuz': bmi < 20 ? 'ectomorph_balanced' : 'lean_balanced',
                'Geniş Omuz': bmi < 20 ? 'ectomorph_broad' : 'lean_broad'
            },
            'Standart Yapılı': {
                'Dar Omuz': bmi < 25 ? 'mesomorph_narrow' : 'average_narrow',
                'Normal Omuz': bmi < 25 ? 'mesomorph_balanced' : 'average_balanced',
                'Geniş Omuz': bmi < 25 ? 'mesomorph_broad' : 'average_broad'
            },
            'İri Yapılı': {
                'Dar Omuz': bmi < 30 ? 'endomorph_narrow' : 'heavy_narrow',
                'Normal Omuz': bmi < 30 ? 'endomorph_balanced' : 'heavy_balanced',
                'Geniş Omuz': bmi < 30 ? 'endomorph_broad' : 'heavy_broad'
            }
        };
        
        return frameMatrix[bodyType][shoulderWidth];
    }

    function getEnhancedVisualDescriptors(height, weight, bmi, ageGroup, gender, bodyType, shoulderWidth) {
        const descriptors = [];
        
        // Yaş bazlı tanımlamalar
        if (ageGroup === 'Genç (14-17)') {
            descriptors.push(gender === 'Kadın' ? 'teenage female' : 'teenage male');
        } else {
            descriptors.push(gender === 'Kadın' ? 'adult female' : 'adult male');
        }
        
        // Boy tanımlamaları
        const heightThreshold = gender === 'Kadın' ? 165 : 175;
        if (height < heightThreshold - 10) descriptors.push('noticeably short stature');
        else if (height > heightThreshold + 15) descriptors.push('tall and imposing stature');
        
        // Kilo tanımlamaları
        if (bmi < 18.5) descriptors.push('very lean and slender build');
        else if (bmi >= 30) descriptors.push('heavy-set and substantial build');
        else if (bmi >= 25) descriptors.push('fuller and stockier build');
        
        // Vücut tipi tanımlamaları
        if (bodyType === 'İnce Yapılı') {
            descriptors.push('naturally thin frame');
        } else if (bodyType === 'İri Yapılı') {
            descriptors.push('naturally broad and thick frame');
        }
        
        // Omuz tanımlamaları
        if (shoulderWidth === 'Dar Omuz') {
            descriptors.push('narrow and sloping shoulders');
        } else if (shoulderWidth === 'Geniş Omuz') {
            descriptors.push('wide and strong shoulders');
        }
        
        return descriptors;
    }

    function buildAdvancedImagePrompt(profile, recommendedSize) {
        const basePrompt = `Ultra-realistic 3D render of a ${profile.visualDescriptors.join(', ')} mannequin in a professional product photography setting.`;
        
        const physicalDescription = buildPhysicalDescription(profile);
        const clothingDescription = `wearing a black, oversized, boxy-fit cotton t-shirt (size ${recommendedSize}) and light blue relaxed-fit denim shorts`;
        const technicalSpecs = `Split-panel view (front and side), studio lighting, white background, photorealistic rendering, high detail, 4K quality`;
        const measurementLines = `Include thin gray measurement lines: horizontal chest line labeled "Chest: ${TEE_SIZE_CHART[recommendedSize].width}cm", vertical length line labeled "Length: ${TEE_SIZE_CHART[recommendedSize].length}cm"`;
        const brandInfo = `"LOS SURENOS" text at top center in clean sans-serif font`;
        
        return `${basePrompt} ${physicalDescription} ${clothingDescription}. ${technicalSpecs}. ${measurementLines}. ${brandInfo}. Do NOT include any Turkish characters or words.`;
    }

    function buildPhysicalDescription(profile) {
        const parts = [];
        
        if (profile.heightCategory.category === 'very_short') {
            parts.push(`A noticeably short figure (${profile.height}cm)`);
        } else if (profile.heightCategory.category === 'very_tall') {
            parts.push(`A tall figure (${profile.height}cm)`);
        } else {
            parts.push(`A ${profile.heightCategory.category} height figure (${profile.height}cm)`);
        }
        
        parts.push(`with ${profile.weightCategory.description}`);
        
        if (profile.bodyFrame.includes('narrow')) {
            parts.push('narrow shoulders and slim torso');
        } else if (profile.bodyFrame.includes('broad')) {
            parts.push('broad shoulders and wide torso');
        }
        
        return parts.join(' ');
    }

    const callBackendAPI = async (endpoint, payload) => {
        try {
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ payload })
            });
            if (!response.ok) {
                 const err = await response.json();
                 throw new Error(err.error || `API Hatası: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Hata (${endpoint}):`, error);
            showAlert(`API Hatası: ${error.message}`);
            return null;
        }
    };

    // ANA ANALİZ FONKSİYONU
    const runAnalysis = async () => {
        userData.height = heightSlider.value;
        userData.weight = weightSlider.value;
        if (userData.mode === 'measure') {
            userData.teeWidth = teeWidthSlider.value;
            userData.teeLength = teeLengthSlider.value;
        }

        if (userData.mode === 'wizard' && (!userData.bodyType || !userData.shoulderWidth)) {
            showAlert("Lütfen tüm adımları eksiksiz doldurun.");
            return;
        }
        
        showStep('step-loader');

        try {
            // Gelişmiş beden tahmini algoritması (yaş ve cinsiyet dahil)
            const preliminaryResult = getImprovedSizeRecommendation(
                parseInt(userData.height),
                parseInt(userData.weight),
                userData.ageGroup,
                userData.gender,
                userData.bodyType,
                userData.shoulderWidth,
                userData.mode === 'measure' ? parseInt(userData.teeWidth) : null,
                userData.mode === 'measure' ? parseInt(userData.teeLength) : null
            );

            // Gemini AI uzman görüşü
            const geminiResult = await getAdvancedGeminiRecommendation(userData);

            if (geminiResult && geminiResult.recommendedSize) {
                // Gemini sonuçlarını kullan
                userData.recommendedSize = geminiResult.recommendedSize;
                userData.explanation = geminiResult.explanation;
                userData.confidence = geminiResult.confidence || preliminaryResult.confidence;
                userData.fitAnalysis = geminiResult.fitAnalysis;
                userData.alternativeSizes = geminiResult.alternativeSizes;
                userData.warnings = geminiResult.warnings;
            } else {
                // Fallback: Gelişmiş algoritma sonuçlarını kullan
                userData.recommendedSize = preliminaryResult.recommendedSize;
                userData.explanation = preliminaryResult.reasoning || 'Tüm özelliklerinize göre en uygun beden seçildi.';
                userData.confidence = preliminaryResult.confidence;
            }

            // Sonuçları göster
            updateResultUI();
            showStep('step-result');

            // Görsel oluştur (sadece wizard modunda)
            if (userData.mode === 'wizard') {
                generateFitPreviewImage();
            } else {
                const previewSection = document.getElementById('ai-fit-preview-section');
                if (previewSection) {
                    previewSection.style.display = 'none';
                }
            }

        } catch (error) {
            console.error('Analiz hatası:', error);
            showAlert('Analiz sırasında bir hata oluştu. Lütfen tekrar deneyin.');
            showStep('step-5');
        }
    };

    // SONUÇ UI GÜNCELLEMESİ
    function updateResultUI() {
        // Temel bilgiler
        document.getElementById('result-size').textContent = userData.recommendedSize;
        document.getElementById('add-to-cart-btn').textContent = `Beden ${userData.recommendedSize} Sepete Ekle`;
        resultDescription.textContent = userData.explanation;
        
        // Güven skoru göster
        if (userData.confidence) {
            const confidenceElement = document.getElementById('confidence-score');
            if (confidenceElement) {
                confidenceElement.textContent = `Güven: %${Math.round(userData.confidence)}`;
                confidenceElement.className = userData.confidence > 80 ? 'text-green-600 font-semibold' : 
                                             userData.confidence > 60 ? 'text-yellow-600 font-semibold' : 'text-red-600 font-semibold';
            }
        }
        
        // Fit analizi göster
        if (userData.fitAnalysis) {
            updateFitAnalysisUI(userData.fitAnalysis);
        }
        
        // Alternatif bedenler göster
        if (userData.alternativeSizes && userData.alternativeSizes.length > 0) {
            updateAlternativeSizesUI(userData.alternativeSizes);
        }
        
        // Uyarılar göster
        if (userData.warnings && userData.warnings.length > 0) {
            updateWarningsUI(userData.warnings);
        }
    }

    function updateFitAnalysisUI(fitAnalysis) {
        const fitContainer = document.getElementById('fit-analysis-container');
        if (fitContainer) {
            fitContainer.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg mt-4">
                    <h4 class="font-semibold mb-2">Detaylı Fit Analizi:</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><strong>Göğüs:</strong> ${fitAnalysis.chestFit || 'Uygun'}</div>
                        <div><strong>Boy:</strong> ${fitAnalysis.lengthFit || 'Uygun'}</div>
                        <div><strong>Omuz:</strong> ${fitAnalysis.shoulderFit || 'Uygun'}</div>
                        <div><strong>Genel:</strong> ${fitAnalysis.overallFit || 'İyi'}</div>
                    </div>
                </div>
            `;
        }
    }

    function updateAlternativeSizesUI(alternativeSizes) {
        const altContainer = document.getElementById('alternative-sizes-container');
        if (altContainer && alternativeSizes && alternativeSizes.length > 0) {
            const altHTML = alternativeSizes.map(alt => 
                `<div class="bg-blue-50 p-2 rounded text-sm">
                    <strong>${alt.size}:</strong> ${alt.reason}
                </div>`
            ).join('');
            
            altContainer.innerHTML = `
                <div class="mt-4">
                    <h4 class="font-semibold mb-2">Alternatif Seçenekler:</h4>
                    <div class="space-y-2">${altHTML}</div>
                </div>
            `;
        }
    }

    function updateWarningsUI(warnings) {
        const warningContainer = document.getElementById('warnings-container');
        if (warningContainer && warnings && warnings.length > 0) {
            const warningHTML = warnings.map(warning => 
                `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-2 text-sm">
                    ⚠️ ${warning}
                </div>`
            ).join('');
            
            warningContainer.innerHTML = `
                <div class="mt-4">
                    <h4 class="font-semibold mb-2 text-yellow-700">Dikkat Edilmesi Gerekenler:</h4>
                    <div class="space-y-2">${warningHTML}</div>
                </div>
            `;
        }
    }

    // GÖRSEL OLUŞTURMA FONKSİYONU
    const generateFitPreviewImage = async () => {
        try {
            if (fitPreviewLoader) {
                fitPreviewLoader.style.display = 'flex';
            }
            if (fitPreviewImage) {
                fitPreviewImage.classList.add('hidden');
            }
            
            const result = await generateAdvancedFitPreview(userData);
            
            if (result && result.imageUrl) {
                fitPreviewImage.src = result.imageUrl;
                fitPreviewImage.onload = () => {
                    if (fitPreviewLoader) {
                        fitPreviewLoader.style.display = 'none';
                    }
                    if (fitPreviewImage) {
                        fitPreviewImage.classList.remove('hidden');
                    }
                };
                fitPreviewImage.onerror = () => {
                    if (fitPreviewLoader) {
                        fitPreviewLoader.innerHTML = `<p class="text-red-500 text-xs p-4">Görsel yüklenemedi.</p>`;
                    }
                };
            } else {
                showAlert(`Görsel oluşturulamadı: ${result?.error || 'Bilinmeyen hata'}`);
                if (fitPreviewLoader) {
                    fitPreviewLoader.innerHTML = `<p class="text-red-500 text-xs p-4">Önizleme oluşturulamadı.</p>`;
                }
            }
        } catch (error) {
            console.error('Görsel oluşturma hatası:', error);
            showAlert('Görsel oluşturulurken hata oluştu.');
            if (fitPreviewLoader) {
                fitPreviewLoader.innerHTML = `<p class="text-red-500 text-xs p-4">Görsel oluşturulamadı.</p>`;
            }
        }
    };

    // RESET FONKSİYONU
    const resetWizard = () => {
        userData = {};
        showStep('step-0'); // Yaş/cinsiyet adımından başlat
        
        const previewSection = document.getElementById('ai-fit-preview-section');
        if (previewSection) {
            previewSection.style.display = 'block';
        }
        if (fitPreviewLoader) {
            fitPreviewLoader.style.display = 'flex';
            fitPreviewLoader.innerHTML = '<div class="loader"></div><p class="text-sm text-gray-600 mt-2">Önizleme oluşturuluyor...</p>';
        }
        if (fitPreviewImage) {
            fitPreviewImage.classList.add('hidden');
            fitPreviewImage.src = "";
        }
        
        // Sonuç konteynerlarını temizle
        const containers = ['fit-analysis-container', 'alternative-sizes-container', 'warnings-container', 'confidence-score'];
        containers.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.innerHTML = '';
        });

        // Visual selector seçimlerini temizle
        document.querySelectorAll('.visual-selector-card.selected').forEach(card => {
            card.classList.remove('selected');
        });

        // Slider değerlerini sıfırla
        if (heightSlider) {
            heightSlider.value = 175;
            heightValueDisplay.textContent = '175 cm';
        }
        if (weightSlider) {
            weightSlider.value = 75;
            weightValueDisplay.textContent = '75 kg';
        }
        if (teeWidthSlider) {
            teeWidthSlider.value = 58;
            teeWidthDisplay.textContent = '58 cm';
        }
        if (teeLengthSlider) {
            teeLengthSlider.value = 72;
            teeLengthDisplay.textContent = '72 cm';
        }
    };

    // İNİSYALİZASYON
    try {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    } catch (error) {
        console.warn('Lucide icons yüklenemedi:', error);
    }
    
    resetWizard();
});
</script>

</body>
</html>
