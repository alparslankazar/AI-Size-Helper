<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akıllı Beden Danışmanı - Premium Tee</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --brand-color: #1c1c1e; 
            --text-primary: #1c1c1e;
            --text-secondary: #555;
            --bg-primary: #ffffff;
            --bg-secondary: #f4f5f7;
            --bg-selected: #e9e9ed;
            --border-color: #e5e7eb;
            --button-bg: #1c1c1e;
            --button-text: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .product-card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
        }
        .product-card-image-bg {
            background-color: #f9f9f9;
        }

        #size-wizard-modal {
            background: rgba(30, 30, 32, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        #wizard-content {
            width: 100%;
            max-width: 480px;
            height: auto;
            max-height: 90dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
            border-radius: clamp(16px, 4vw, 24px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            color: var(--text-primary);
        }
        
        @media (min-width: 768px) {
            #wizard-content {
                min-height: 600px;
            }
        }

        .wizard-inner-scroll {
            flex: 1; 
            min-height: 0;
            overflow-y: auto;
            padding: 0 clamp(16px, 5vw, 24px) 24px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--brand-color) transparent;
        }
        .wizard-inner-scroll::-webkit-scrollbar { width: 5px; }
        .wizard-inner-scroll::-webkit-scrollbar-thumb { background-color: var(--brand-color); border-radius: 10px; }

        .visual-selector-card { 
            transition: transform 0.25s cubic-bezier(.4,0,.2,1), background-color 0.25s, box-shadow 0.25s;
            cursor: pointer;
            padding: 4px;
            border-radius: 12px;
            border: 2px solid transparent;
            background-color: var(--bg-secondary);
        }
        .visual-selector-card .image-wrapper {
            background-color: transparent;
            border-radius: 8px;
            overflow: hidden;
        }
        .visual-selector-card img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: contain;
            padding: 0;
            transition: transform 0.25s;
        }
        .visual-selector-card h4 {
            color: var(--text-secondary);
            font-weight: 600;
            transition: color 0.25s;
            font-size: clamp(0.6rem, 2.5vw, 0.875rem);
        }
        .visual-selector-card:hover {
            transform: translateY(-2px);
        }
        .visual-selector-card.selected { 
            background-color: var(--bg-selected);
            transform: translateY(-5px);
            outline: 2px solid var(--brand-color); 
        }
        .visual-selector-card.selected h4, .visual-selector-card.selected svg {
            color: var(--text-primary);
        }
        
        @media (max-width: 640px) {
            .visual-selector-card img {
                transform: scale(1.1);
            }
            .visual-selector-card:hover img {
                transform: scale(1.15);
            }
        }

        .measurement-card img {
            display: block;
            width: 100%;
            max-width: 300px;
            height: auto;
            aspect-ratio: 16 / 9;
            object-fit: contain;
            margin: 0 auto 1rem auto;
            border-radius: 8px;
            background-color: var(--bg-secondary);
        }

        h3.wizard-title {
            font-size: clamp(1.5rem, 4vw, 1.875rem);
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: clamp(0.4rem, 2vh, 1.5rem);
        }
        
        .wizard-label {
            color: var(--text-secondary);
            font-size: clamp(0.7rem, 2.5vw, 1rem);
            margin-bottom: 1rem;
        }

        .value-display {
            font-size: clamp(4rem, 12vw, 5rem);
            font-weight: 900;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .value-display-medium {
            font-size: clamp(3rem, 8vw, 4rem);
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }
        
        .modal-brand-footer {
            flex-shrink: 0;
            width: 100%;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: clamp(11px, 3vw, 15px);
            text-align: center;
            padding: 16px 0;
            letter-spacing: 1px;
            user-select: none;
            border-top: none;
        }
        .wizard-step { display: none; animation: fadeIn 0.4s; }
        .wizard-step.active { display: block; }
        #step-loader.active { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 300px;}
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        .loader { border:4px solid var(--bg-secondary); border-top:4px solid var(--brand-color); border-radius:50%; width:46px; height:46px; animation:spin 1s linear infinite;}
        
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 5px; outline: none; transition: opacity .2s; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { width: 24px; height: 24px; background: var(--bg-primary); cursor: pointer; border-radius: 50%; border: 2px solid var(--brand-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: var(--bg-primary); cursor: pointer; border-radius: 50%; border: 2px solid var(--brand-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .slider-label {
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            color: var(--text-secondary);
            margin-top: 0.75rem;
            text-align: center;
        }

        .action-button {
            background-color: var(--button-bg);
            color: var(--button-text);
            transition: transform 0.2s, background-color 0.2s;
            font-size: clamp(0.7rem, 4vw, 1.125rem);
        }
        .action-button:hover {
            background-color: #333;
            transform: translateY(-2px);
        }
        .prev-btn {
            background-color: transparent;
            color: var(--text-secondary);
        }
        .prev-btn:hover {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        button:disabled{opacity:0.5;cursor:not-allowed;}
        
        .modal-alert { 
            color: #c21c25; 
            font-weight: 500; 
            font-size: clamp(0.8rem, 2.5vw, 0.875rem);
            text-align: center; 
            display: none;
            margin-top: 0.5rem;
        }
        
        .wizard-nav {
            flex-shrink: 0;
            padding: 1rem clamp(16px, 5vw, 24px);
            border-top: 1px solid var(--border-color);
        }

        @media (max-width:480px) {
            #wizard-content { max-width: 95vw; }
        }
    </style>
</head>
<body class="text-gray-900">

<div class="container mx-auto p-4 md:p-8">
    <h1 class="text-3xl font-bold mb-4 text-center tracking-tight text-gray-900">Premium Oversize Tee</h1>
    <div class="product-card max-w-md mx-auto rounded-xl shadow-lg overflow-hidden md:max-w-2xl border">
        <div class="md:flex">
            <div class="product-card-image-bg md:flex-shrink-0 flex items-center justify-center">
                <img class="h-48 w-full object-cover md:h-full md:w-48" src="https://placehold.co/600x800/f4f5f7/333?text=LOS%20SURENOS" alt="[LOS SURENOS Gri Tişört]" loading="lazy">
            </div>
            <div class="p-8">
                <div class="uppercase tracking-wide text-sm text-violet-600 font-semibold">Yeni Koleksiyon</div>
                <p class="block mt-1 text-lg leading-tight font-medium text-black">Unisex Boxy Fit Tee</p>
                <p class="mt-2 text-gray-600">Mükemmel kesimi ve premium kumaşıyla gardırobunuzun favorisi olacak.</p>
                <div class="mt-4">
                    <span class="text-2xl font-bold text-gray-900">749.99 TL</span>
                </div>
                <div class="mt-6">
                    <button id="open-wizard-btn" class="action-button w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                        <i data-lucide="scan-line" class="mr-2"></i>
                        Sana Özel Bedeni Bulalım
                    </button>
                    <p class="text-xs text-center mt-2 text-gray-500">Yapay zeka destekli beden danışmanını keşfet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="size-wizard-modal" class="fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
    <div id="wizard-content">
        <div class="flex-shrink-0 flex justify-center items-center p-4 border-b border-[var(--border-color)] relative">
            <h2 class="text-base font-bold flex items-center gap-2">
                <i data-lucide="badge-check" class="w-6 h-6 text-gray-800"></i> Akıllı Beden Danışmanı
            </h2>
            <button id="close-wizard-btn" class="text-gray-500 hover:text-gray-900 absolute top-1/2 right-4 -translate-y-1/2">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="flex-shrink-0 p-5 pt-4">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-gray-800 h-2.5 rounded-full transition-all duration-500" style="width:0%"></div>
            </div>
        </div>
        <div class="wizard-inner-scroll">
            <!-- Adım 0: Yaş ve Cinsiyet -->
            <div id="step-0" class="wizard-step active text-center">
                <h3 class="wizard-title">Seni Tanıyalım</h3>
                <p class="wizard-label">Doğru öneri için bu iki bilgi önemli.</p>
                <div class="space-y-8">
                    <div>
                        <h4 class="font-semibold mb-4 text-lg">Yaşın</h4>
                        <p id="age-value-display" class="value-display !text-7xl !mb-2">25</p>
                        <input type="range" id="age-slider" min="15" max="45" value="25" class="w-full">
                        <p class="slider-label">Yaşını ayarlamak için kaydır</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3 text-lg">Cinsiyet</h4>
                        <div class="grid grid-cols-2 gap-4" data-group="gender">
                            <button class="visual-selector-card p-4 flex flex-col items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M18 10a6 6 0 0 0-12 0"/><path d="M12 22V10"/><path d="m7 15 5 5 5-5"/></svg>
                                <h4>Erkek</h4>
                            </button>
                            <button class="visual-selector-card p-4 flex flex-col items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/><path d="M12 22v-6"/><path d="M9 9h6"/></svg>
                                <h4>Kadın</h4>
                            </button>
                        </div>
                         <div id="gender-alert" class="modal-alert">Lütfen bir cinsiyet seçiniz!</div>
                    </div>
                </div>
            </div>

            <!-- Adım 1: Yöntem Seçimi -->
            <div id="step-1" class="wizard-step text-center">
                <h3 class="wizard-title">Sana en uygun bedeni nasıl bulalım?</h3>
                <p class="wizard-label">İki farklı yöntemle sana özel önerimizi anında öğren.</p>
                <div class="space-y-4">
                    <button data-target-step="step-2" data-mode="wizard" class="start-btn action-button w-full font-bold py-4 px-4 rounded-lg flex items-center justify-center">
                        <i data-lucide="user-check" class="mr-3"></i> Vücut Ölçülerimle Bul
                    </button>
                    <button data-target-step="step-m1" data-mode="measure" class="start-btn action-button w-full font-bold py-4 px-4 rounded-lg flex items-center justify-center">
                        <i data-lucide="ruler" class="mr-3"></i> Favori Tişörtümü Ölçerek Bul
                    </button>
                </div>
                <p class="text-xs mt-6 text-gray-500"><i data-lucide="lock" class="inline-block w-3 h-3 mr-1"></i>Bilgilerin sadece beden hesaplamak için kullanılır.</p>
            </div>

            <!-- Adım 2: Boy Seçimi -->
            <div id="step-2" class="wizard-step">
                <div class="text-center">
                    <h3 class="wizard-title">Boyun kaç cm?</h3>
                    <p id="height-value-display" class="value-display">175 cm</p>
                    <input type="range" id="height-slider" min="140" max="200" value="175" class="w-full">
                    <p class="slider-label">Ölçüyü ayarlamak için kaydır</p>
                </div>
            </div>

            <!-- Adım 3: Kilo Seçimi -->
            <div id="step-3" class="wizard-step">
                <div class="text-center">
                    <h3 class="wizard-title">Kilon kaç kg?</h3>
                    <p id="weight-value-display" class="value-display">75 kg</p>
                    <input type="range" id="weight-slider" min="40" max="110" value="75" class="w-full">
                    <p class="slider-label">Ölçüyü ayarlamak için kaydır</p>
                </div>
            </div>

            <!-- Adım 4: Vücut Tipi -->
            <div id="step-4" class="wizard-step">
                <h3 class="wizard-title text-center">Vücut tipin hangisi?</h3>
                <div class="grid grid-cols-3 gap-2 mb-1" data-group="bodyType">
                    <div class="visual-selector-card text-center" data-value="İnce Yapılı">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/fe980448-a30c-47fd-8c65-05ec05b27034/image_1080.webp" alt="[İnce yapılı vücut tipi]"></div>
                        <h4 class="text-sm mt-2">İnce Yapılı</h4>
                    </div>
                    <div class="visual-selector-card text-center" data-value="Standart Yapılı">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/0db45a1b-030c-4c18-aee7-36e80cc89c40/image_1080.webp" alt="[Standart yapılı vücut tipi]"></div>
                        <h4 class="text-sm mt-2">Standart Yapılı</h4>
                    </div>
                    <div class="visual-selector-card text-center" data-value="İri Yapılı">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/c4b2e1b1-488c-408c-a388-3feedaa53955/image_1080.webp" alt="[İri yapılı vücut tipi]"></div>
                        <h4 class="text-sm mt-2">İri Yapılı</h4>
                    </div>
                </div>
                <div id="bodytype-alert" class="modal-alert">Lütfen bir vücut tipi seçiniz!</div>
            </div>

            <!-- Adım 5: Omuz Genişliği -->
            <div id="step-5" class="wizard-step">
                <h3 class="wizard-title text-center">Omuz genişliğin nasıl?</h3>
                <div class="grid grid-cols-3 gap-2 mb-1" data-group="shoulderWidth">
                    <div class="visual-selector-card text-center" data-value="Dar Omuz">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/0a00cb0e-637c-41d8-84ac-63d19065b16b/image_1080.webp" alt="[Dar omuzlu vücut tipi]"></div>
                        <h4 class="text-sm mt-2">Dar Omuz</h4>
                    </div>
                    <div class="visual-selector-card text-center" data-value="Normal Omuz">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/75e11e3b-a7ae-4205-9c9f-44ad00c208ac/image_1080.webp" alt="[Normal omuzlu vücut tipi]"></div>
                        <h4 class="text-sm mt-2">Normal Omuz</h4>
                    </div>
                    <div class="visual-selector-card text-center" data-value="Geniş Omuz">
                        <div class="image-wrapper"><img src="https://cdn.myikas.com/images/theme-images/24c35eb8-abfb-4ab6-a33d-4f887ac3ab1a/image_1080.webp" alt="[Geniş omuzlu vücut tipi]"></div>
                        <h4 class="text-sm mt-2">Geniş Omuz</h4>
                    </div>
                </div>
                <div id="shoulder-alert" class="modal-alert">Lütfen bir omuz genişliği seçiniz!</div>
            </div>

            <!-- Adım M1 & M2 (Ölçüm) -->
            <div id="step-m1" class="wizard-step">
                <div class="text-center measurement-card">
                    <h3 class="wizard-title">Favori tişörtünün genişliği?</h3>
                    <img src="https://placehold.co/400x300/f4f5f7/333?text=Genişlik+(En)" alt="[Tişört genişlik ölçümü görseli]">
                    <p id="tee-width-display" class="value-display-medium mt-4">58 cm</p>
                    <input type="range" id="tee-width-slider" min="40" max="80" value="58" class="w-full">
                    <p class="slider-label">Ölçüyü ayarlamak için kaydır</p>
                </div>
            </div>
            <div id="step-m2" class="wizard-step">
                <div class="text-center measurement-card">
                    <h3 class="wizard-title">Favori tişörtünün boyu?</h3>
                    <img src="https://placehold.co/400x300/f4f5f7/333?text=Uzunluk+(Boy)" alt="[Tişört boy ölçümü görseli]">
                    <p id="tee-length-display" class="value-display-medium mt-4">72 cm</p>
                    <input type="range" id="tee-length-slider" min="60" max="90" value="72" class="w-full">
                    <p class="slider-label">Ölçüyü ayarlamak için kaydır</p>
                </div>
            </div>

            <!-- Yükleniyor Ekranı -->
            <div id="step-loader" class="wizard-step text-center">
                <div class="loader"></div>
                <h3 class="text-2xl font-bold mt-6">Analiz Ediliyor...</h3>
                <p class="text-gray-600 mt-2">✨ Yapay zeka, verilerinize göre en uygun bedeni ve kişisel yorumu hazırlıyor.</p>
            </div>

            <!-- Sonuç Ekranı -->
            <div id="step-result" class="wizard-step text-center">
                <i data-lucide="party-popper" class="mx-auto w-16 h-16 text-green-500"></i>
                <h3 class="wizard-title mt-4">Sana Özel Önerimiz:</h3>
                <p id="result-size" class="text-7xl font-black text-gray-800 my-4">L</p>
                <div class="bg-gray-100 rounded-lg p-4 text-sm text-left mb-3 border border-gray-200">
                    <p id="result-description"></p>
                    
                    <div id="ai-fit-preview-section" class="mt-6 text-left">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">AI Destekli Fit Önizlemesi</h4>
                        <div id="fit-preview-container" class="w-full aspect-square bg-gray-200 rounded-lg flex items-center justify-center border border-gray-300 overflow-hidden relative">
                            <div id="fit-preview-loader" class="text-center flex flex-col items-center justify-center absolute inset-0">
                                <div class="loader"></div>
                                <p class="text-sm text-gray-600 mt-2">Önizleme oluşturuluyor...</p>
                            </div>
                            <img id="fit-preview-image" src="" alt="AI Destekli Fit Önizlemesi" class="w-full h-full object-cover hidden">
                        </div>
                        <p class="text-[11px] text-gray-500 mt-2 ml-1">Görsel, yapay zeka tarafından ölçülerinize özel olarak oluşturulmuştur.</p>
                    </div>

                </div>
                <div class="mt-6">
                    <button id="add-to-cart-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Bu Bedeni Sepete Ekle</button>
                    <button class="restart-btn mt-2 w-full text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-200">Yeniden Başla</button>
                </div>
            </div>
        </div>
        <div class="wizard-nav">
            <div class="flex justify-between">
                <button id="nav-prev" class="prev-btn font-bold py-2 px-4 rounded-lg">Geri</button>
                <button id="nav-next" class="next-btn action-button font-bold py-2 px-6 rounded-lg">İleri</button>
                <button id="nav-analyze" class="analyze-btn action-button font-bold py-2 px-6 rounded-lg" style="display:none;">Analiz Et</button>
            </div>
        </div>
        <div class="modal-brand-footer">LOS SURENOS®</div>
    </div>
</div>

<div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100] hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
        <p id="custom-alert-message" class="text-lg text-gray-700 mb-4"></p>
        <button id="custom-alert-close-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Tamam</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Çeviri haritaları
    const enBodyTypes = {
        'İnce Yapılı': 'Slim build',
        'Standart Yapılı': 'Standard build',
        'İri Yapılı': 'Heavy-set build'
    };
    const enShoulderWidths = {
        'Dar Omuz': 'Narrow shoulders',
        'Normal Omuz': 'Standard shoulders',
        'Geniş Omuz': 'Broad shoulders'
    };

    // Element Selections
    const wizardModal = document.getElementById('size-wizard-modal');
    const steps = document.querySelectorAll('.wizard-step');
    const progressBar = document.getElementById('progress-bar');
    const navPrev = document.getElementById('nav-prev');
    const navNext = document.getElementById('nav-next');
    const navAnalyze = document.getElementById('nav-analyze');
    const ageSlider = document.getElementById('age-slider');
    const ageValueDisplay = document.getElementById('age-value-display');
    const heightSlider = document.getElementById('height-slider');
    const heightValueDisplay = document.getElementById('height-value-display');
    const weightSlider = document.getElementById('weight-slider');
    const weightValueDisplay = document.getElementById('weight-value-display');
    const teeWidthSlider = document.getElementById('tee-width-slider');
    const teeWidthDisplay = document.getElementById('tee-width-display');
    const teeLengthSlider = document.getElementById('tee-length-slider');
    const teeLengthDisplay = document.getElementById('tee-length-display');
    const bodyTypeAlert = document.getElementById('bodytype-alert');
    const shoulderAlert = document.getElementById('shoulder-alert');
    const ageAlert = document.getElementById('age-alert');
    const genderAlert = document.getElementById('gender-alert');
    const resultDescription = document.getElementById('result-description');
    const fitPreviewLoader = document.getElementById('fit-preview-loader');
    const fitPreviewImage = document.getElementById('fit-preview-image');

    // State Variables
    let currentStepId = 'step-0';
    let userData = {};
    const TEE_SIZE_CHART = {
        'S': { width: 60, length: 70 },
        'M': { width: 62, length: 72 },
        'L': { width: 64, length: 74 },
        'XL': { width: 66, length: 76 }
    };

    // Modal & Alert Logic
    const openModal = () => { wizardModal.classList.remove('hidden'); resetWizard(); };
    const closeModal = () => { wizardModal.classList.add('hidden');};
    const showAlert = (message) => { document.getElementById('custom-alert-message').textContent = message; document.getElementById('custom-alert-modal').classList.remove('hidden'); };
    document.getElementById('open-wizard-btn').addEventListener('click', openModal);
    document.getElementById('close-wizard-btn').addEventListener('click', closeModal);
    wizardModal.addEventListener('click', (e) => e.target === wizardModal && closeModal());
    document.getElementById('custom-alert-close-btn').addEventListener('click', () => { document.getElementById('custom-alert-modal').classList.add('hidden'); });

    // Navigation config
    const stepConfig = {
        'step-0': { prev: null, next: 'step-1' },
        'step-1': { prev: 'step-0', next: null, hideNav: true },
        'step-2': { prev: 'step-1', next: 'step-3' },
        'step-3': { prev: 'step-2', next: (data) => data.mode === 'wizard' ? 'step-4' : null, isAnalyze: (data) => data.mode === 'measure' },
        'step-4': { prev: 'step-3', next: 'step-5' },
        'step-5': { prev: 'step-4', next: null, isAnalyze: true },
        'step-m1': { prev: 'step-1', next: 'step-m2' },
        'step-m2': { prev: 'step-m1', next: 'step-2' },
        'step-loader': { hideNav: true },
        'step-result': { hideNav: true }
    };

    const updateNavigation = (stepId) => {
        const config = stepConfig[stepId];
        const navContainer = document.querySelector('.wizard-nav');
        if (!config) return;
        if (config.hideNav) { navContainer.style.display = 'none'; return; }
        navContainer.style.display = 'block';
        navPrev.style.display = config.prev ? 'block' : 'none';
        if(config.prev) navPrev.dataset.targetStep = config.prev;
        const nextTarget = typeof config.next === 'function' ? config.next(userData) : config.next;
        navNext.style.display = nextTarget ? 'block' : 'none';
        if(nextTarget) navNext.dataset.targetStep = nextTarget;
        const showAnalyze = typeof config.isAnalyze === 'function' ? config.isAnalyze(userData) : config.isAnalyze;
        navAnalyze.style.display = showAnalyze ? 'block' : 'none';
        if(showAnalyze) navNext.style.display = 'none';
    };
    
    const showStep = (stepId) => {
        if (currentStepId === 'step-0' && stepId === 'step-1') {
            if (!userData.age) {
                userData.age = ageSlider.value;
            }
            if (!userData.gender) {
                genderAlert.style.display = "block"; setTimeout(() => genderAlert.style.display = "none", 1800); return;
            }
        }
        if (currentStepId === 'step-4' && stepId === 'step-5' && !userData.bodyType) {
            bodyTypeAlert.style.display = "block"; setTimeout(() => bodyTypeAlert.style.display = "none", 1800); return;
        }
        if (currentStepId === 'step-5' && stepId.startsWith('step-loader') && !userData.shoulderWidth) {
            shoulderAlert.style.display = "block"; setTimeout(() => shoulderAlert.style.display = "none", 1800); return;
        }
        currentStepId = stepId;
        steps.forEach(step => step.classList.remove('active'));
        const activeStep = document.getElementById(stepId);
        if (activeStep) activeStep.classList.add('active');
        document.querySelector('.wizard-inner-scroll').scrollTop = 0;
        updateProgressBar();
        updateNavigation(stepId);
    };

    const updateProgressBar = () => {
        const wizardFlow = ['step-0', 'step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
        const measureFlow = ['step-0', 'step-1', 'step-m1', 'step-m2', 'step-2', 'step-3'];
        const currentFlow = userData.mode === 'wizard' ? wizardFlow : measureFlow;
        const stepIndex = currentFlow.indexOf(currentStepId);
        let progress = 0;
        if (stepIndex !== -1) {
            progress = ((stepIndex + 1) / currentFlow.length) * 100;
        } else if (currentStepId === 'step-result' || currentStepId.startsWith('step-loader')) {
            progress = 100;
        }
        progressBar.style.width = `${progress}%`;
    };
    
    document.querySelectorAll('.start-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            userData.mode = btn.dataset.mode;
            showStep(btn.dataset.targetStep);
        });
    });

    navPrev.addEventListener('click', () => showStep(navPrev.dataset.targetStep));
    navNext.addEventListener('click', () => showStep(navNext.dataset.targetStep));
    navAnalyze.addEventListener('click', () => runAnalysis());
    document.querySelector('.restart-btn').addEventListener('click', () => resetWizard());

    // Sliders
    ageSlider.addEventListener('input', (e) => {
        ageValueDisplay.textContent = e.target.value;
        userData.age = e.target.value;
    });
    heightSlider.addEventListener('input', (e) => heightValueDisplay.textContent = `${e.target.value} cm`);
    weightSlider.addEventListener('input', (e) => weightValueDisplay.textContent = `${e.target.value} kg`);
    teeWidthSlider.addEventListener('input', (e) => teeWidthDisplay.textContent = `${e.target.value} cm`);
    teeLengthSlider.addEventListener('input', (e) => teeLengthDisplay.textContent = `${e.target.value} cm`);
    
    document.querySelectorAll('.visual-selector-card').forEach(card => {
        card.addEventListener('click', () => {
            const group = card.closest('[data-group]').dataset.group;
            document.querySelectorAll(`[data-group="${group}"] .visual-selector-card`).forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            userData[group] = card.querySelector('h4').textContent;
        });
    });

    // KURAL TABANLI BEDEN HESAPLAMA
    function getRuleBasedRecommendation(height, weight, age, gender, bodyType, shoulderWidth) {
        const ageGroup = age < 18 ? 'Genç' : 'Yetişkin';
        let baseSize;

        if (gender === 'Erkek') {
            if (ageGroup === 'Yetişkin') {
                if (height < 175) {
                    if (weight < 65) baseSize = 'S';
                    else if (weight < 78) baseSize = 'M';
                    else baseSize = 'L';
                } else if (height <= 185) {
                    if (weight < 65) baseSize = 'M';
                    else if (weight < 78) baseSize = 'L';
                    else if (weight < 96) baseSize = 'L';
                    else baseSize = 'XL';
                } else { // > 185
                    if (weight < 78) baseSize = 'L';
                    else baseSize = 'XL';
                }
            } else { // Genç
                if (height < 175) {
                    if (weight < 60) baseSize = 'S';
                    else if (weight < 75) baseSize = 'M';
                    else baseSize = 'L';
                } else if (height <= 185) {
                    if (weight < 60) baseSize = 'S';
                    else if (weight < 75) baseSize = 'M';
                    else baseSize = 'L';
                } else { // > 185
                    if (weight < 75) baseSize = 'M';
                    else if (weight < 85) baseSize = 'L';
                    else baseSize = 'XL';
                }
            }
        } else { // Kadın
            if (height < 165) {
                if (weight < 60) baseSize = 'S';
                else if (weight < 75) baseSize = 'M';
                else baseSize = 'L';
            } else if (height <= 175) {
                if (weight < 60) baseSize = 'S';
                else if (weight < 75) baseSize = 'M';
                else baseSize = 'L';
            } else { // > 175
                if (weight < 60) baseSize = 'M';
                else if (weight < 75) baseSize = 'L';
                else baseSize = 'XL';
            }
        }

        const modifier = (bodyType === 'İri Yapılı' || shoulderWidth === 'Geniş Omuz') ? 1 : 
                         (bodyType === 'İnce Yapılı' || shoulderWidth === 'Dar Omuz') ? -1 : 0;
        
        const sizes = ['S', 'M', 'L', 'XL'];
        const currentIndex = sizes.indexOf(baseSize);
        let finalIndex = currentIndex + modifier;
        finalIndex = Math.max(0, Math.min(sizes.length - 1, finalIndex));

        return sizes[finalIndex];
    }

    // GEMINI AI YORUMCU PROMPT'U
    const getGeminiExplanation = async (analysisData) => {
        const { height, weight, bmiCategory, bodyType, shoulderWidth, finalSize, gender, age } = analysisData;
        
        const personaAndProductContext = `
Sen, LOS SURENOS markasının baş stil danışmanısın. Bir asistan, müşteri için bir analiz yaptı ve bedene karar verdi. Senin görevin, bu kararı müşteriye en iyi şekilde açıklayan bir metin yazmak.
- Ürün: Oversized Boxy Fit Tee, 220 GSM ağır pamuk, geniş ve modern kalıp.
- Bedenler ve Ölçüler: S(Genişlik:60, Boy:70), M(62/72), L(64/74), XL(66/76).
- KESİNLİKLE UYULMASI GEREKEN KURALLAR:
  1. ASLA reklam veya marka övgüsü yapma.
  2. SADECE S, M, L, XL bedenlerini kullan. Başka dilde veya başka bir kodla (XS, XXL vb.) asla bahsetme.
  3. Yanıtını SADECE şu JSON formatında ver: {"explanation":"..."} Başka hiçbir metin ekleme.
`;
        const assistantReport = `
- **ASİSTAN KARARI:**
  - **Müşteri Profili:** ${age} yaşında, ${gender}.
  - **Objektif Veriler:** Müşteri ${height}cm boyunda, ${weight}kg ağırlığında. Bu, Vücut Kitle İndeksi'ne (BMI) göre '${bmiCategory}' bir fizik anlamına geliyor.
  - **Subjektif Veriler (Müşterinin Kendi Algısı):** Müşteri vücut tipini '${bodyType}', omuz genişliğini ise '${shoulderWidth}' olarak seçti.
  - **VERİLEN KARAR:** Bu müşteri için en uygun beden **${finalSize}**.
- **SENİN GÖREVİN (YORUMCULUK):**
  Lütfen asistanın verdiği **${finalSize}** beden kararını temel alarak, bunun neden doğru bir seçim olduğunu müşteriye açıkla. Hem objektif verilere (BMI, boy) hem de müşterinin kendi algısına (vücut tipi, omuz seçimi) saygı gösteren kişisel bir dil kullan. Eğer müşterinin seçimi ile BMI arasında çelişki varsa, buna nazikçe değin.
`;
        const payload = {
            contents: [{ role: "user", parts: [{ text: `${personaAndProductContext}\n${assistantReport}` }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: { "explanation": { "type": "STRING" } },
                    required: ["explanation"]
                }
            }
        };
        const result = await callBackendAPI("/api/gemini", payload);
        return result ? JSON.parse(result.candidates[0].content.parts[0].text) : null;
    };

    const generateFitPreviewImage = async () => {
        const { height, weight, bodyType, shoulderWidth, recommendedSize, gender, age } = userData;

        const bodyTypeEn = enBodyTypes[bodyType] || 'Standard build';
        const shoulderWidthEn = enShoulderWidths[shoulderWidth] || 'Standard shoulders';

        const heightM = parseInt(height) / 100;
        const bmi = parseInt(weight) / (heightM * heightM);
        
        let physiqueDescription = `A hyper-realistic 3D render of a ${parseInt(age) < 18 ? 'teenage' : 'adult'} ${gender === 'Kadın' ? 'female' : 'male'} mannequin.`;
        
        let physiqueDetails = '';
        if (parseInt(height) < (gender === 'Kadın' ? 165 : 172)) physiqueDetails += 'a short stature, ';
        else if (parseInt(height) > 185) physiqueDetails += 'a tall stature, ';
        else physiqueDetails += 'an average stature, ';

        if (gender === 'Kadın') {
            if (bmi < 19) physiqueDetails += 'and a noticeably underweight and slender body frame. Avoid any muscular or heavy appearance.';
            else if (bmi < 22) physiqueDetails += 'and a slim, toned athletic body frame. The physique should look balanced.';
            else if (bmi < 25) physiqueDetails += 'and a healthy, average feminine body with soft curves. Not overly athletic but not overweight.';
            else if (bmi < 30) physiqueDetails += 'and a curvy, hourglass feminine figure with noticeably wide hips and a full bust.';
            else physiqueDetails += 'and a plus-size, heavy-set feminine figure with a soft, rounded belly and thick thighs.';
        } else { // Erkek
            if (bmi < 20) physiqueDetails += 'and a noticeably thin, slender, ectomorph body frame.';
            else if (bmi < 25) physiqueDetails += 'and an athletic, toned, mesomorph body frame with visible muscle definition.';
            else if (bmi < 30) physiqueDetails += 'and a stocky, endomorph body frame with a fuller torso, not overly fat but with substance.';
            else physiqueDetails += 'and a visibly large, heavy-set body frame with a large torso and thick limbs.';
        }
        
        physiqueDescription += ` The mannequin's physique MUST visually represent a person with ${physiqueDetails}`;

        const imagePrompt = `
(${physiqueDescription}:1.5), in a split-panel view (front and side).
The t-shirt's drape and fit MUST accurately reflect how a size ${recommendedSize} garment would look on this specific body type. Show realistic fabric tension where needed, and looseness elsewhere.
The mannequin wears a black, oversized, boxy-fit t-shirt and pale light-blue, baggy denim shorts.
The background is solid pure white.
The following text elements, and only these elements, must be rendered in a clean, bold, sans-serif font:
- Top Center: LOS SURENOS
- Upper Left Corner (Front View): Height: ${height} cm, Weight: ${weight} kg, Body Type: ${bodyTypeEn}, Shoulder: ${shoulderWidthEn}, Size: ${recommendedSize}
- Front View Measurement: A thin, horizontal, gray dashed line across the chest, labeled "Chest Width: ${TEE_SIZE_CHART[recommendedSize].width} cm".
- Side View Measurement: A thin, vertical, gray dashed line from shoulder to hem, labeled "Tshirt Length: ${TEE_SIZE_CHART[recommendedSize].length} cm".
Crucial Negative Prompts: Do NOT include any Turkish characters or words. no headless mannequin, no missing limbs, no extra text, logos, watermarks, or shadows.
`;
        const payload = {
            prompt: imagePrompt,
            seed: 500097,
        };
        
        const result = await callBackendAPI("/api/generate-image", payload);
        
        if (result && result.imageUrl) {
            fitPreviewImage.src = result.imageUrl;
            fitPreviewImage.onload = () => {
                fitPreviewLoader.style.display = 'none';
                fitPreviewImage.classList.remove('hidden');
            };
        } else {
            showAlert(`Görsel oluşturulamadı: ${result?.error || 'Bilinmeyen bir hata oluştu.'}`);
            fitPreviewLoader.innerHTML = `<p class="text-red-500 text-xs p-4">Önizleme oluşturulamadı.</p>`;
        }
    };

    const callBackendAPI = async (endpoint, payload) => {
        try {
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ payload })
            });
            if (!response.ok) {
                 const err = await response.json();
                 throw new Error(err.error || `API Hatası: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Hata (${endpoint}):`, error);
            showAlert(`API Hatası: ${error.message}`);
            return null;
        }
    };

    const runAnalysis = async () => {
        userData.height = heightSlider.value;
        userData.weight = weightSlider.value;
        if (userData.mode === 'measure') {
            userData.teeWidth = teeWidthSlider.value;
            userData.teeLength = teeLengthSlider.value;
        }

        if (userData.mode === 'wizard' && (!userData.bodyType || !userData.shoulderWidth)) {
            showAlert("Lütfen tüm adımları eksiksiz doldurun.");
            return;
        }
        
        showStep('step-loader');

        const height = parseInt(userData.height);
        const weight = parseInt(userData.weight);
        const bmi = weight / ((height / 100) * (height / 100));
        let bmiCategory = 'Normal';
        if (bmi < 19) bmiCategory = 'Zayıf';
        else if (bmi >= 25 && bmi < 30) bmiCategory = 'Kilolu';
        else if (bmi >= 30) bmiCategory = 'Obez';
        
        // 1. KARAR: Beden, kural tabanlı sistem tarafından kesin olarak hesaplanır.
        const finalSize = getRuleBasedRecommendation(height, weight, userData.age, userData.gender, userData.bodyType, userData.shoulderWidth);
        userData.recommendedSize = finalSize;

        // 2. YORUM: Yapay zekaya, bizim verdiğimiz kararı açıklaması için rapor gönderilir.
        const analysisData = {
            height, weight, bmiCategory, 
            bodyType: userData.bodyType, 
            shoulderWidth: userData.shoulderWidth, 
            finalSize, // Kararımızı gönderiyoruz
            gender: userData.gender,
            age: userData.age
        };
        
        let geminiResult = await getGeminiExplanation(analysisData);

        if (!geminiResult || !geminiResult.explanation) {
            userData.explanation = `Vücut ölçülerinize göre sizin için en uygun bedenin ${finalSize} olduğunu düşünüyoruz. Bu beden, tişörtün üzerinizde modern ve rahat bir oversize duruş sergilemesini sağlayacaktır.`;
        } else {
            userData.explanation = geminiResult.explanation;
        }
        
        // 3. GÖSTERİM: Sonuçlar ekrana yazdırılır.
        document.getElementById('result-size').textContent = userData.recommendedSize;
        document.getElementById('add-to-cart-btn').textContent = `Beden ${userData.recommendedSize} Sepete Ekle`;
        resultDescription.textContent = userData.explanation;
        
        showStep('step-result');

        // 4. GÖRSELLEŞTİRME: Nihai karara göre görsel oluşturulur.
        if (userData.mode === 'wizard') {
             generateFitPreviewImage();
        } else {
            document.getElementById('ai-fit-preview-section').style.display = 'none';
        }
    };

    const resetWizard = () => {
        userData = {};
        userData.age = ageSlider.value;
        ageValueDisplay.textContent = ageSlider.value;
        
        showStep('step-0');
        
        const previewSection = document.getElementById('ai-fit-preview-section');
        if (previewSection) {
            previewSection.style.display = 'block';
        }
        if (fitPreviewLoader) {
            fitPreviewLoader.style.display = 'flex';
            fitPreviewLoader.innerHTML = '<div class="loader"></div><p class="text-sm text-gray-600 mt-2">Önizleme oluşturuluyor...</p>';
        }
        if (fitPreviewImage) {
            fitPreviewImage.classList.add('hidden');
            fitPreviewImage.src = "";
        }
    };

    lucide.createIcons();
    resetWizard();
});
</script>

</body>
</html>
