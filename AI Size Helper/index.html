<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akıllı Beden Danışmanı - Premium Tee</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .wizard-step {
            display: none;
            animation: fadeIn 0.5s;
        }
        .wizard-step.active {
            display: block;
        }
        #step-loader.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .selectable-card {
            transition: transform 0.2s, background-color 0.2s;
            background-color: #f9fafb;
        }
        .selectable-card.selected {
            background-color: #e5e7eb;
            transform: scale(1.05);
        }
        .selectable-card img, .measurement-card img {
            height: 120px;
            width: auto;
            margin: 0.5rem auto;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        .loader {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #374151;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        .loader-small {
            width: 20px;
            height: 20px;
            border-width: 2px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #1f2937;
            cursor: pointer;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #1f2937;
            cursor: pointer;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #ai-chat-history p { margin-bottom: 0.5rem; }
        #ai-chat-history p.user-question { font-weight: 600; color: #4b5563; }
        #ai-chat-history p.ai-answer { color: #1f2937; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-4 text-center">Premium Oversize Tee</h1>
        <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden md:max-w-2xl">
            <div class="md:flex">
                <div class="md:flex-shrink-0">
                    <img class="h-48 w-full object-cover md:h-full md:w-48" src="https://placehold.co/600x800/e5e7eb/374151?text=Tee" alt="[Gri Tişört görseli]" onerror="this.onerror=null;this.src='https://placehold.co/600x800/e5e7eb/374151?text=Image+Not+Found';">
                </div>
                <div class="p-8">
                    <div class="uppercase tracking-wide text-sm text-gray-600 font-semibold">Yeni Koleksiyon</div>
                    <p class="block mt-1 text-lg leading-tight font-medium text-black">Unisex Boxy Fit Tee</p>
                    <p class="mt-2 text-gray-500">Mükemmel kesimi ve premium kumaşıyla gardırobunuzun favorisi olacak.</p>
                    <div class="mt-4">
                        <span class="text-2xl font-bold text-gray-900">749.99 TL</span>
                    </div>
                    <div class="mt-6">
                        <button id="open-wizard-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                            <i data-lucide="scan-line" class="mr-2"></i>
                            Sana Özel Bedeni Bulalım
                        </button>
                        <p class="text-xs text-center mt-2 text-gray-500">Yapay zeka destekli beden danışmanını keşfet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="size-wizard-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div id="wizard-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">✨ Akıllı Beden Danışmanı</h2>
                <button id="close-wizard-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-5">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-gray-800 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="p-6 min-h-[400px] flex flex-col justify-between">
                <!-- Adım 1: Yöntem Seçimi -->
                <div id="step-1" class="wizard-step active text-center">
                    <h3 class="text-2xl font-bold mb-4">Sana en uygun bedeni nasıl bulalım?</h3>
                    <p class="text-gray-500 mb-8">İki farklı yöntemle sana özel önerimizi anında öğren.</p>
                    <div class="space-y-4">
                        <button data-target-step="step-2" data-mode="wizard" class="start-btn w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-4 rounded-lg transition flex items-center justify-center text-lg">
                            <i data-lucide="user-check" class="mr-3"></i>
                            Vücut Ölçülerimle Bul
                        </button>
                        <button data-target-step="step-m1" data-mode="measure" class="start-btn w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-4 rounded-lg transition flex items-center justify-center text-lg">
                            <i data-lucide="ruler" class="mr-3"></i>
                            Favori Tişörtümü Ölçerek Bul
                        </button>
                    </div>
                     <p class="text-xs mt-6 text-gray-400"><i data-lucide="lock" class="inline-block w-3 h-3 mr-1"></i>Bilgilerin tamamen güvende.</p>
                </div>

                <!-- Adım 2: Boy Seçimi (Ortak) -->
                <div id="step-2" class="wizard-step">
                     <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">Boyun kaç cm?</h3>
                        <p id="height-value-display" class="text-6xl font-extrabold text-gray-800 mb-8">175 cm</p>
                        <input type="range" id="height-slider" min="140" max="220" value="175" class="w-full">
                    </div>
                    <div class="mt-8 flex justify-between">
                        <button data-target-step="step-1" class="prev-btn text-gray-500 font-bold py-2 px-4 rounded">Geri</button>
                        <button data-target-step="step-3" class="next-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">İleri</button>
                    </div>
                </div>

                <!-- Adım 3: Kilo Seçimi (Ortak) -->
                <div id="step-3" class="wizard-step">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">Kilon kaç kg?</h3>
                        <p id="weight-value-display" class="text-6xl font-extrabold text-gray-800 mb-8">75 kg</p>
                        <input type="range" id="weight-slider" min="40" max="150" value="75" class="w-full">
                    </div>
                    <div class="mt-8 flex justify-between">
                        <button data-target-step="step-2" class="prev-btn text-gray-500 font-bold py-2 px-4 rounded">Geri</button>
                        <button data-target-step="step-4" id="kilo-next-btn-wizard" class="next-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">İleri</button>
                        <button id="kilo-analyze-btn-measure" class="analyze-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg" style="display: none;">Analiz Et</button>
                    </div>
                </div>

                <!-- Adım 4: Vücut Tipi -->
                <div id="step-4" class="wizard-step">
                    <h3 class="text-2xl font-bold mb-4 text-center">Vücut tipin en çok hangisine benziyor?</h3>
                    <div class="grid grid-cols-3 gap-3" data-group="bodyType">
                        <div class="selectable-card rounded-lg p-3 text-center cursor-pointer" data-value="ince yapılı">
                            <img src="https://placehold.co/300x400/e5e7eb/374151?text=İnce" alt="[İnce yapılı vücut tipi]">
                            <h4 class="font-bold text-sm">İnce Yapılı</h4>
                        </div>
                        <div class="selectable-card rounded-lg p-3 text-center cursor-pointer" data-value="standart yapılı">
                            <img src="https://placehold.co/300x400/e5e7eb/374151?text=Standart" alt="[Standart yapılı vücut tipi]">
                            <h4 class="font-bold text-sm">Standart Yapılı</h4>
                        </div>
                        <div class="selectable-card rounded-lg p-3 text-center cursor-pointer" data-value="iri yapılı">
                            <img src="https://placehold.co/300x400/e5e7eb/374151?text=İri" alt="[İri yapılı vücut tipi]">
                            <h4 class="font-bold text-sm">İri Yapılı</h4>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-between">
                        <button data-target-step="step-3" class="prev-btn text-gray-500 font-bold py-2 px-4 rounded">Geri</button>
                        <button data-target-step="step-5" class="next-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">İleri</button>
                    </div>
                </div>

                <!-- Adım 5: Omuz Genişliği -->
                <div id="step-5" class="wizard-step">
                    <h3 class="text-2xl font-bold mb-4 text-center">Omuz genişliğin hangisine benziyor?</h3>
                    <div class="grid grid-cols-3 gap-3" data-group="shoulderWidth">
                         <div class="selectable-card rounded-lg p-3 text-center cursor-pointer" data-value="dar">
                            <img src="https://placehold.co/300x400/e5e7eb/374151?text=Dar+Omuz" alt="[Dar omuzlu vücut tipi]">
                            <h4 class="font-bold text-sm">Dar Omuz</h4>
                        </div>
                        <div class="selectable-card rounded-lg p-3 text-center cursor-pointer" data-value="normal">
                            <img src="https://placehold.co/300x400/e5e7eb/374151?text=Normal+Omuz" alt="[Normal omuzlu vücut tipi]">
                            <h4 class="font-bold text-sm">Normal Omuz</h4>
                        </div>
                        <div class="selectable-card rounded-lg p-3 text-center cursor-pointer" data-value="geniş">
                            <img src="https://placehold.co/300x400/e5e7eb/374151?text=Geniş+Omuz" alt="[Geniş omuzlu vücut tipi]">
                            <h4 class="font-bold text-sm">Geniş Omuz</h4>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-between">
                        <button data-target-step="step-4" class="prev-btn text-gray-500 font-bold py-2 px-4 rounded">Geri</button>
                        <button class="analyze-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Analiz Et</button>
                    </div>
                </div>

                <!-- Adım M1: Tişört Genişliği -->
                <div id="step-m1" class="wizard-step">
                    <div class="text-center measurement-card">
                        <h3 class="text-2xl font-bold mb-2">Favori tişörtünün genişliği?</h3>
                        <p class="text-gray-500 mb-4 text-sm">İki koltuk altı arasını ölç (cm).</p>
                        <img src="https://placehold.co/400x300/e5e7eb/374151?text=Genişlik+(En)" alt="[Tişört genişlik ölçümü görseli]">
                        <p id="tee-width-display" class="text-6xl font-extrabold text-gray-800 my-4">58 cm</p>
                        <input type="range" id="tee-width-slider" min="40" max="80" value="58" class="w-full">
                    </div>
                    <div class="mt-8 flex justify-between">
                        <button data-target-step="step-1" class="prev-btn text-gray-500 font-bold py-2 px-4 rounded">Geri</button>
                        <button data-target-step="step-m2" class="next-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">İleri</button>
                    </div>
                </div>
                
                <!-- Adım M2: Tişört Boyu -->
                <div id="step-m2" class="wizard-step">
                    <div class="text-center measurement-card">
                        <h3 class="text-2xl font-bold mb-2">Favori tişörtünün boyu?</h3>
                        <p class="text-gray-500 mb-4 text-sm">Omuzdan etek ucuna kadar ölç (cm).</p>
                        <img src="https://placehold.co/400x300/e5e7eb/374151?text=Uzunluk+(Boy)" alt="[Tişört boy ölçümü görseli]">
                        <p id="tee-length-display" class="text-6xl font-extrabold text-gray-800 my-4">72 cm</p>
                        <input type="range" id="tee-length-slider" min="60" max="90" value="72" class="w-full">
                    </div>
                    <div class="mt-8 flex justify-between">
                        <button data-target-step="step-m1" class="prev-btn text-gray-500 font-bold py-2 px-4 rounded">Geri</button>
                        <button data-target-step="step-2" class="next-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">İleri</button>
                    </div>
                </div>

                <!-- Yükleniyor Ekranı -->
                <div id="step-loader" class="wizard-step text-center h-full">
                     <div class="loader mx-auto"></div>
                     <h3 class="text-2xl font-bold mt-6">Analiz Ediliyor...</h3>
                     <p class="text-gray-500 mt-2">✨ Yapay zeka, verilerinize göre en uygun bedeni ve kişisel yorumu hazırlıyor.</p>
                </div>

                <!-- Sonuç Ekranı -->
                <div id="step-result" class="wizard-step text-center">
                    <i data-lucide="party-popper" class="mx-auto w-16 h-16 text-green-500"></i>
                    <h3 class="text-2xl font-bold mt-4">Sana Özel Önerimiz:</h3>
                    <p id="result-size" class="text-7xl font-black text-gray-800 my-4">L</p>
                    <div class="bg-gray-100 rounded-lg p-4 text-sm text-left">
                        <p id="result-description"></p>
                    </div>
                    
                    <div id="ask-ai-section" class="mt-6 text-left">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Yapay Zekaya Sor</h4>
                        <div id="ai-chat-history" class="bg-gray-100 rounded-lg p-3 min-h-[80px] max-h-[180px] overflow-y-auto mb-3 border border-gray-200">
                            <!-- Chat messages will appear here -->
                        </div>
                        <div id="ai-chat-loader" class="hidden my-2 flex items-center justify-center space-x-2 text-sm text-gray-500">
                            <div class="loader loader-small"></div>
                            <span>Yapay zeka düşünüyor...</span>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="ai-question-input" placeholder="Örn: Daha bol dursun diye ne yapmalıyım?" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500">
                            <button id="ask-ai-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <button id="add-to-cart-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            Bu Bedeni Sepete Ekle
                        </button>
                        <button class="restart-btn mt-2 w-full text-gray-500 font-bold py-2 px-4 rounded">
                            Yeniden Başla
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="custom-alert-message" class="text-lg text-gray-700 mb-4"></p>
            <button id="custom-alert-close-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Tamam</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Selections ---
            const wizardModal = document.getElementById('size-wizard-modal');
            const wizardContent = document.getElementById('wizard-content');
            const progressBar = document.getElementById('progress-bar');
            const steps = document.querySelectorAll('.wizard-step');
            
            const heightSlider = document.getElementById('height-slider');
            const heightValueDisplay = document.getElementById('height-value-display');
            const weightSlider = document.getElementById('weight-slider');
            const weightValueDisplay = document.getElementById('weight-value-display');
            const teeWidthSlider = document.getElementById('tee-width-slider');
            const teeWidthDisplay = document.getElementById('tee-width-display');
            const teeLengthSlider = document.getElementById('tee-length-slider');
            const teeLengthDisplay = document.getElementById('tee-length-display');
            
            const askAiBtn = document.getElementById('ask-ai-btn');
            const aiQuestionInput = document.getElementById('ai-question-input');
            const aiChatHistoryDiv = document.getElementById('ai-chat-history');
            const aiChatLoader = document.getElementById('ai-chat-loader');

            const kiloNextBtnWizard = document.getElementById('kilo-next-btn-wizard');
            const kiloAnalyzeBtnMeasure = document.getElementById('kilo-analyze-btn-measure');

            // --- State Variables ---
            let currentStepId = 'step-1';
            let userData = {};
            let aiChatHistory = [];
            const TEE_SIZE_CHART = {
                'S': { width: 55, length: 70 },
                'M': { width: 58, length: 72 },
                'L': { width: 61, length: 74 },
                'XL': { width: 64, length: 76 },
            };

            // --- Modal & Alert Logic ---
            const openModal = () => {
                wizardModal.classList.remove('hidden');
                setTimeout(() => wizardContent.classList.remove('scale-95', 'opacity-0'), 10);
                resetWizard();
            };
            const closeModal = () => {
                wizardContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => wizardModal.classList.add('hidden'), 300);
            };
            const showAlert = (message) => {
                document.getElementById('custom-alert-message').textContent = message;
                document.getElementById('custom-alert-modal').classList.remove('hidden');
            };

            document.getElementById('open-wizard-btn').addEventListener('click', openModal);
            document.getElementById('close-wizard-btn').addEventListener('click', closeModal);
            wizardModal.addEventListener('click', (e) => e.target === wizardModal && closeModal());
            document.getElementById('custom-alert-close-btn').addEventListener('click', () => {
                document.getElementById('custom-alert-modal').classList.add('hidden');
            });

            // --- Wizard Navigation ---
            const showStep = (stepId) => {
                currentStepId = stepId;
                steps.forEach(step => step.classList.remove('active'));
                const activeStep = document.getElementById(stepId);
                if (activeStep) {
                    activeStep.classList.add('active');
                } else {
                    console.error("Step not found:", stepId);
                }
                updateProgressBar();
            };
            
            const updateProgressBar = () => {
                const wizardFlow = ['step-2', 'step-3', 'step-4', 'step-5'];
                const measureFlow = ['step-m1', 'step-m2', 'step-2', 'step-3'];
                const currentFlow = userData.mode === 'wizard' ? wizardFlow : measureFlow;
                
                const stepIndex = currentFlow.indexOf(currentStepId);
                let progress = 0;
                if (stepIndex !== -1) {
                    progress = ((stepIndex + 1) / currentFlow.length) * 100;
                } else if (currentStepId === 'step-result' || currentStepId === 'step-loader') {
                    progress = 100;
                }
                progressBar.style.width = `${progress}%`;
            };
            
            document.querySelectorAll('.start-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    userData.mode = btn.dataset.mode;
                    if (userData.mode === 'measure') {
                        kiloNextBtnWizard.style.display = 'none';
                        kiloAnalyzeBtnMeasure.style.display = 'block';
                    } else { // wizard mode
                        kiloNextBtnWizard.style.display = 'block';
                        kiloAnalyzeBtnMeasure.style.display = 'none';
                    }
                    showStep(btn.dataset.targetStep);
                });
            });

            document.querySelectorAll('.next-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showStep(btn.dataset.targetStep);
                });
            });
            
            document.querySelectorAll('.prev-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.targetStep === 'step-1') {
                         kiloNextBtnWizard.style.display = 'block';
                         kiloAnalyzeBtnMeasure.style.display = 'none';
                    }
                    showStep(btn.dataset.targetStep)
                });
            });

            document.querySelectorAll('.restart-btn').forEach(btn => {
                btn.addEventListener('click', () => resetWizard());
            });

            document.querySelectorAll('.analyze-btn').forEach(button => {
                 button.addEventListener('click', async () => {
                    if (userData.mode === 'wizard') {
                        if (!userData.bodyType) { showAlert('Lütfen bir vücut tipi seçin.'); return; }
                        if (!userData.shoulderWidth) { showAlert('Lütfen bir omuz genişliği seçin.'); return; }
                    }
                    await runAnalysis();
                });
            });

            // --- User Input & Selections ---
            heightSlider.addEventListener('input', (e) => heightValueDisplay.textContent = `${e.target.value} cm`);
            weightSlider.addEventListener('input', (e) => weightValueDisplay.textContent = `${e.target.value} kg`);
            teeWidthSlider.addEventListener('input', (e) => teeWidthDisplay.textContent = `${e.target.value} cm`);
            teeLengthSlider.addEventListener('input', (e) => teeLengthDisplay.textContent = `${e.target.value} cm`);

            document.querySelectorAll('.selectable-card').forEach(card => {
                card.addEventListener('click', () => {
                    const group = card.closest('[data-group]').dataset.group;
                    document.querySelectorAll(`[data-group="${group}"] .selectable-card`).forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    userData[group] = card.dataset.value; 
                });
            });

            // --- Gemini API Integration ---
            const callGeminiAPI = async (payload) => {
                const apiKey = ""; // Handled by environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    }
                    console.error("Unexpected API response:", result);
                    return null;
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    showAlert(`Yapay zeka ile iletişimde bir hata oluştu: ${error.message}`);
                    return null;
                }
            };

            const getGeminiSizeRecommendation = async () => {
                let prompt;
                if (userData.mode === 'wizard') {
                    prompt = `You are an expert AI size advisor for a "Premium Oversize Tee". Available sizes are S, M, L, XL. Based on the user data (Height: ${userData.height}cm, Weight: ${userData.weight}kg, Body Type: '${userData.bodyType}', Shoulder Width: '${userData.shoulderWidth}'), recommend the best size for a stylish oversized look. Provide a friendly, personalized explanation in Turkish. Respond in a JSON object with keys "recommendedSize" and "explanation".`;
                } else { // measure mode
                    const sizeChartString = JSON.stringify(TEE_SIZE_CHART);
                    prompt = `You are an expert AI size advisor for a "Premium Oversize Tee". The product's size chart (width x length) is: ${sizeChartString}. A user provided their favorite T-shirt's measurements and their body stats. User data: Favorite Tee Width: ${userData.teeWidth}cm, Favorite Tee Length: ${userData.teeLength}cm, User Height: ${userData.height}cm, User Weight: ${userData.weight}kg. Compare the user's tee to the chart and recommend the best size for a similar or slightly more oversized fit. Provide a friendly, personalized explanation in Turkish. Respond in a JSON object with keys "recommendedSize" and "explanation".`;
                }

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "recommendedSize": { "type": "STRING", "enum": ["S", "M", "L", "XL"] },
                                "explanation": { "type": "STRING" }
                            },
                            required: ["recommendedSize", "explanation"]
                        }
                    }
                };
                const resultText = await callGeminiAPI(payload);
                return resultText ? JSON.parse(resultText) : null;
            };

            const handleAskAI = async () => {
                const question = aiQuestionInput.value.trim();
                if (!question) return;

                aiQuestionInput.value = '';
                aiChatLoader.classList.remove('hidden');
                askAiBtn.disabled = true;

                updateChatHistory('user', question);
                aiChatHistory.push({ role: 'user', parts: [{ text: question }] });

                const systemContext = `You are a helpful AI size and fit expert for a "Premium Oversize Tee". You have already provided an initial recommendation. Now, answer the user's follow-up questions concisely and helpfully in Turkish, maintaining the context. Initial User Data: ${JSON.stringify(userData)}. Initial Recommendation: Size ${userData.recommendedSize}. Initial Explanation: ${userData.explanation}.`;
                
                const payload = {
                    contents: [
                        { role: "user", parts: [{ text: systemContext }] },
                        { role: "model", parts: [{ text: "Anladım, kullanıcının sorularını bu bağlamda yanıtlayacağım." }] },
                        ...aiChatHistory
                    ]
                };

                const responseText = await callGeminiAPI(payload);
                if (responseText) {
                    updateChatHistory('model', responseText);
                    aiChatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                } else {
                    updateChatHistory('model', 'Üzgünüm, bir sorun oluştu. Lütfen tekrar dene.');
                }
                
                aiChatLoader.classList.add('hidden');
                askAiBtn.disabled = false;
                aiQuestionInput.focus();
            };
            
            askAiBtn.addEventListener('click', handleAskAI);
            aiQuestionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAskAI();
            });

            const updateChatHistory = (role, text) => {
                const p = document.createElement('p');
                p.classList.add(role === 'user' ? 'user-question' : 'ai-answer');
                p.textContent = text;
                aiChatHistoryDiv.appendChild(p);
                aiChatHistoryDiv.scrollTop = aiChatHistoryDiv.scrollHeight;
            };

            // --- Main Analysis Flow ---
            const runAnalysis = async () => {
                showStep('step-loader');
                
                userData.height = heightSlider.value;
                userData.weight = weightSlider.value;
                if (userData.mode === 'measure') {
                    userData.teeWidth = teeWidthSlider.value;
                    userData.teeLength = teeLengthSlider.value;
                }

                const result = await getGeminiSizeRecommendation();
                if (result) {
                    userData.recommendedSize = result.recommendedSize;
                    userData.explanation = result.explanation;
                    document.getElementById('result-size').textContent = result.recommendedSize;
                    document.getElementById('add-to-cart-btn').textContent = `Beden ${result.recommendedSize} Sepete Ekle`;
                    document.getElementById('result-description').textContent = result.explanation;
                    showStep('step-result');
                } else {
                    showAlert('Beden önerisi alınırken bir hata oluştu. Lütfen önceki adıma dönüp tekrar deneyin.');
                    showStep(userData.mode === 'wizard' ? 'step-5' : 'step-3');
                }
            };
            
            // --- Wizard Reset ---
            const resetWizard = () => {
                userData = {};
                aiChatHistory = [];
                aiChatHistoryDiv.innerHTML = '';
                
                kiloNextBtnWizard.style.display = 'block';
                kiloAnalyzeBtnMeasure.style.display = 'none';
                
                heightSlider.value = 175;
                weightSlider.value = 75;
                teeWidthSlider.value = 58;
                teeLengthSlider.value = 72;
                
                heightValueDisplay.textContent = '175 cm';
                weightValueDisplay.textContent = '75 kg';
                teeWidthDisplay.textContent = '58 cm';
                teeLengthDisplay.textContent = '72 cm';

                document.querySelectorAll('.selectable-card').forEach(card => card.classList.remove('selected'));
                showStep('step-1');
            };

            // --- Initial Setup ---
            lucide.createIcons();
            resetWizard();
        });
    </script>
</body>
</html>
